<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hesitation Research - Admin Console</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .fade-out { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- 锁定屏幕 -->
    <div id="lock-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center transition-all duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">研究员登录</h2>
            <p class="text-sm text-slate-500 mb-6">Hesitation Research Project</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 rounded-lg border border-slate-300 mb-4 focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest" placeholder="访问密码 (1234)">
            <button onclick="window.AuthSystem.login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                进入系统
            </button>
            <p id="login-msg" class="text-red-500 text-xs mt-4 h-4"></p>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="app-container" class="flex flex-1 h-full overflow-hidden opacity-0 transition-opacity duration-500">
        <!-- 左侧边栏 -->
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">H</div>
                <span class="font-bold text-white tracking-wide">Research<span class="font-normal text-slate-500">Lab</span></span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="window.UI.switchTab('questions')" id="nav-questions" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-blue-400 bg-slate-800">
                    <i class="fa-solid fa-database w-5"></i> 题库标定
                </button>
                <button onclick="window.UI.switchTab('analytics')" id="nav-analytics" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-chart-line w-5"></i> 犹豫行为分析
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                <p>Project ID: hesitation-research</p>
            </div>
        </aside>

        <!-- 右侧主内容 -->
        <main class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col">
            <header class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-8 shadow-sm z-10">
                <h1 id="page-title" class="text-xl font-bold text-slate-800">心理测量学题库管理</h1>
                <div class="flex gap-4">
                    <button class="text-slate-400 hover:text-red-600 transition-colors" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
                <!-- 1. 题库管理视图 -->
                <section id="view-questions" class="space-y-6 max-w-6xl mx-auto animate-fade-in">
                    <div class="glass-panel p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-slate-700"><i class="fa-solid fa-plus-circle mr-2 text-blue-600"></i>录入新试题</h3>
                        </div>
                        <form id="question-form" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">题干内容 (Stem)</label>
                                <textarea id="input-stem" rows="3" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="请输入题目描述..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bloom's Taxonomy</label>
                                    <select id="input-bloom" class="w-full p-2 rounded border border-slate-300 text-sm">
                                        <option value="Remember">记忆 (Remember)</option>
                                        <option value="Understand">理解 (Understand)</option>
                                        <option value="Apply">应用 (Apply)</option>
                                        <option value="Analyze">分析 (Analyze)</option>
                                        <option value="Evaluate">评价 (Evaluate)</option>
                                        <option value="Create">创造 (Create)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IRT 难度 (b)</label>
                                    <input type="number" id="input-difficulty" step="0.1" min="-3" max="3" value="0.0" class="w-full p-2 rounded border border-slate-300 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IRT 区分度 (a)</label>
                                    <input type="number" id="input-discrimination" step="0.1" min="0" max="3" value="1.0" class="w-full p-2 rounded border border-slate-300 text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">选项设定 (选中圆点为正确答案)</label>
                                <div id="options-list" class="space-y-2"></div>
                                <button type="button" onclick="window.QuestionManager.addOptionField()" class="mt-2 text-xs text-blue-600 hover:underline">+ 添加选项</button>
                            </div>
                            <div class="pt-4 border-t border-slate-100 flex justify-end">
                                <button type="button" onclick="window.QuestionManager.submit()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg transition-transform active:scale-95">
                                    录入数据库
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="glass-panel p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-700">题库列表 (<span id="q-count">0</span>)</h3>
                        </div>
                        <div id="questions-container" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
                    </div>
                </section>

                <!-- 2. 数据分析视图 -->
                <section id="view-analytics" class="hidden space-y-6 max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <p class="text-xs text-slate-400 uppercase">总样本量</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-sessions">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                            <p class="text-xs text-slate-400 uppercase">平均犹豫指数</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-entropy">0.00</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                            <p class="text-xs text-slate-400 uppercase">答案修改率</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-switch">0%</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                            <p class="text-xs text-slate-400 uppercase">有效数据点</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-datapoints">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm h-[400px] flex flex-col">
                            <h3 class="text-sm font-bold text-slate-700 mb-4">难度 vs. 犹豫 (Yerkes-Dodson Law)</h3>
                            <div class="flex-1 relative">
                                <canvas id="chart-yerkes"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm h-[400px] flex flex-col">
                            <h3 class="text-sm font-bold text-slate-700 mb-4">Bloom认知层级犹豫分布</h3>
                            <div class="flex-1 relative">
                                <canvas id="chart-bloom"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 配置信息
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375",
            measurementId: "G-ZNZ14Q5R98"
        };

        const PROJECT_ID = "hesitation-research"; // 用于 Firestore 路径

        // 全局状态
        const state = {
            questions: [],
            sessions: [],
            charts: {},
            db: null,
        };

        // 1. 认证系统
        const AuthSystem = {
            async init() {
                try {
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    const auth = getAuth(app);
                    await signInAnonymously(auth);
                    console.log("Admin Logged In");
                    DataService.listenQuestions();
                    DataService.listenSessions();
                } catch (e) {
                    console.error("Init Failed", e);
                    alert("数据库连接失败，请检查控制台");
                }
            },
            login() {
                const pwd = document.getElementById('password-input').value;
                if (pwd === '1234') { 
                    document.getElementById('lock-screen').classList.add('fade-out');
                    document.getElementById('app-container').classList.remove('opacity-0');
                    // 检查 URL 参数，如果指定了 tab 则跳转
                    const urlParams = new URLSearchParams(window.location.search);
                    const tab = urlParams.get('tab');
                    if(tab) UI.switchTab(tab);
                    this.init();
                } else {
                    document.getElementById('login-msg').innerText = "密码错误 (默认: 1234)";
                }
            }
        };

        // 2. 数据服务
        const DataService = {
            getCollectionRef(colName) {
                return collection(state.db, 'artifacts', PROJECT_ID, 'public', 'data', colName);
            },
            listenQuestions() {
                const q = query(this.getCollectionRef('question_bank'), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    state.questions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    UI.renderQuestionList();
                    AnalyticsEngine.update();
                });
            },
            listenSessions() {
                const q = query(this.getCollectionRef('exam_results'), orderBy('submittedAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    state.sessions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    AnalyticsEngine.update();
                });
            },
            async addQuestion(data) {
                await addDoc(this.getCollectionRef('question_bank'), data);
            },
            async deleteQuestion(id) {
                if(confirm("确定删除此题吗？")) {
                    await deleteDoc(doc(state.db, 'artifacts', PROJECT_ID, 'public', 'data', 'question_bank', id));
                }
            }
        };

        // 3. 题库管理
        const QuestionManager = {
            options: [], 
            init() {
                this.options = ['A', 'B']; 
                this.renderOptions();
            },
            addOptionField() {
                if (this.options.length >= 6) return;
                const nextChar = String.fromCharCode(65 + this.options.length);
                this.options.push(nextChar);
                this.renderOptions();
            },
            removeOptionField(idx) {
                if (this.options.length <= 2) return;
                this.options.splice(idx, 1);
                this.renderOptions();
            },
            renderOptions() {
                const container = document.getElementById('options-list');
                container.innerHTML = '';
                this.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="radio" name="correct-opt" value="${idx}" ${idx===0?'checked':''} class="w-4 h-4 text-blue-600 cursor-pointer">
                        <input type="text" data-idx="${idx}" class="opt-text flex-1 px-3 py-2 rounded border border-slate-200 text-sm focus:border-blue-500 outline-none" placeholder="选项 ${String.fromCharCode(65+idx)}">
                        ${this.options.length > 2 ? `<button type="button" onclick="window.QuestionManager.removeOptionField(${idx})" class="text-slate-400 hover:text-red-500">×</button>` : ''}
                    `;
                    container.appendChild(div);
                });
            },
            async submit() {
                const stem = document.getElementById('input-stem').value.trim();
                if (!stem) return alert("题干不能为空");
                const optInputs = document.querySelectorAll('.opt-text');
                const optionsList = [];
                let hasEmpty = false;
                optInputs.forEach(input => {
                    const val = input.value.trim();
                    if (!val) hasEmpty = true;
                    optionsList.push(val);
                });
                if (hasEmpty) return alert("请填写完整选项");
                const correctIdx = document.querySelector('input[name="correct-opt"]:checked').value;
                const payload = {
                    text: stem,
                    options: optionsList,
                    correctIndex: parseInt(correctIdx),
                    metadata: {
                        bloom: document.getElementById('input-bloom').value,
                        difficulty_b: parseFloat(document.getElementById('input-difficulty').value),
                        discrimination_a: parseFloat(document.getElementById('input-discrimination').value)
                    },
                    timestamp: serverTimestamp()
                };
                try {
                    await DataService.addQuestion(payload);
                    document.getElementById('input-stem').value = '';
                    document.querySelectorAll('.opt-text').forEach(i => i.value = '');
                    this.options = ['A', 'B'];
                    this.renderOptions();
                    alert("已录入");
                } catch (e) {
                    console.error(e);
                    alert("录入失败");
                }
            }
        };

        // 4. 分析引擎
        const AnalyticsEngine = {
            update() {
                if (state.sessions.length === 0 || state.questions.length === 0) return;
                const yerkesData = [];
                const bloomStats = {};
                let totalDataPoints = 0;
                let totalSwitch = 0;
                let totalQuestionsAnswered = 0;

                state.sessions.forEach(session => {
                    if (!session.answers) return;
                    session.answers.forEach(ans => {
                        const q = state.questions.find(item => item.id === ans.questionId);
                        if (!q || !ans.behaviorMetrics) return;
                        totalDataPoints++;
                        totalQuestionsAnswered++;
                        if (ans.behaviorMetrics.answerChangeCount > 0) totalSwitch++;
                        
                        // 犹豫指数计算
                        const dur = ans.behaviorMetrics.totalDuration; 
                        const switches = ans.behaviorMetrics.answerChangeCount;
                        const hi = Math.min((dur/60000)*0.7 + (switches * 0.15), 1.0);

                        yerkesData.push({ x: q.metadata.difficulty_b, y: hi });
                        const level = q.metadata.bloom;
                        if (!bloomStats[level]) bloomStats[level] = [];
                        bloomStats[level].push(hi);
                    });
                });

                const avgEntropy = yerkesData.length > 0 ? (yerkesData.reduce((a,b) => a + b.y, 0) / yerkesData.length).toFixed(2) : "0.00";
                const switchRate = totalQuestionsAnswered > 0 ? ((totalSwitch / totalQuestionsAnswered) * 100).toFixed(1) + '%' : "0%";

                document.getElementById('stat-sessions').innerText = state.sessions.length;
                document.getElementById('stat-entropy').innerText = avgEntropy;
                document.getElementById('stat-switch').innerText = switchRate;
                document.getElementById('stat-datapoints').innerText = totalDataPoints;

                this.renderYerkesChart(yerkesData);
                this.renderBloomChart(bloomStats);
            },
            renderYerkesChart(data) {
                const ctx = document.getElementById('chart-yerkes');
                if (state.charts.yerkes) state.charts.yerkes.destroy();
                state.charts.yerkes = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '作答数据点',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: {display: true, text: 'IRT 难度 (b)'}, min: -3, max: 3 },
                            y: { title: {display: true, text: '犹豫指数 (HI)'}, min: 0, max: 1.2 }
                        }
                    }
                });
            },
            renderBloomChart(stats) {
                const ctx = document.getElementById('chart-bloom');
                const labels = Object.keys(stats);
                const values = labels.map(l => {
                    const arr = stats[l];
                    return arr.reduce((a,b)=>a+b,0) / arr.length;
                });
                if (state.charts.bloom) state.charts.bloom.destroy();
                state.charts.bloom = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '平均犹豫指数',
                            data: values,
                            backgroundColor: 'rgba(139, 92, 246, 0.6)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 1 } }
                    }
                });
            }
        };

        const UI = {
            switchTab(tab) {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${tab}`).classList.remove('hidden');
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.remove('text-blue-400', 'bg-slate-800');
                    if (btn.id === `nav-${tab}`) btn.classList.add('text-blue-400', 'bg-slate-800');
                });
                if(tab === 'analytics') AnalyticsEngine.update();
            },
            renderQuestionList() {
                const el = document.getElementById('questions-container');
                if (state.questions.length === 0) {
                    el.innerHTML = '<p class="text-slate-400 text-center py-4">暂无题目，请录入</p>';
                    document.getElementById('q-count').innerText = 0;
                    return;
                }
                el.innerHTML = state.questions.map(q => `
                    <div class="bg-white p-4 rounded-lg border border-slate-100 shadow-sm flex justify-between items-start group hover:border-blue-200 transition-colors">
                        <div class="flex-1">
                            <div class="mb-1">
                                <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-full border border-blue-100 uppercase">${q.metadata.bloom}</span>
                                <span class="text-[10px] font-bold text-slate-500 ml-1 bg-slate-100 px-2 py-1 rounded-full">b=${q.metadata.difficulty_b}</span>
                            </div>
                            <p class="text-sm mt-2 text-slate-700 font-medium">${q.text}</p>
                            <div class="mt-2 text-xs text-slate-400 flex gap-2">
                                ${q.options.map((opt, i) => `<span class="${i === q.correctIndex ? 'text-green-600 font-bold' : ''}">${String.fromCharCode(65+i)}. ${opt}</span>`).join('<span class="mx-1">|</span>')}
                            </div>
                        </div>
                        <button onclick="window.DataService.deleteQuestion('${q.id}')" class="ml-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `).join('');
                document.getElementById('q-count').innerText = state.questions.length;
            }
        };

        window.AuthSystem = AuthSystem;
        window.QuestionManager = QuestionManager;
        window.DataService = DataService;
        window.UI = UI;
        QuestionManager.init();
    </script>
</body>
</html>
