<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶åå° - æ•°æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .chart-wrapper { position: relative; height: 350px; width: 100%; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
        .nav-btn.active { background-color: #2563eb; color: white; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- 1. é”å± -->
    <div id="lock-screen" class="fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-6 text-white"><i class="fa-solid fa-shield-halved text-blue-500 mr-2"></i>æ•°æ®ä¸­å¿ƒ</h2>
            <input type="password" id="password-input" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-center text-white focus:border-blue-500 outline-none mb-4 tracking-[0.5em] transition-all" placeholder="â€¢â€¢â€¢â€¢">
            <button onclick="window.checkPassword()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-all">è§£é”</button>
            <p id="init-status" class="text-xs text-slate-500 mt-4">ç­‰å¾…è§£é”...</p>
        </div>
    </div>

    <!-- 2. é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 shrink-0 flex justify-between items-center z-40">
        <div class="flex items-center gap-6">
            <a href="index.html" class="text-slate-500 hover:text-white transition-colors" title="è¿”å›é¦–é¡µ"><i class="fa-solid fa-house"></i></a>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-server text-blue-500 text-xl"></i>
                <h1 class="font-bold text-lg hidden md:block">AI è¡Œä¸ºç ”ç©¶</h1>
            </div>
            <!-- é¡µé¢åˆ‡æ¢å¯¼èˆª -->
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="window.switchTab('dashboard')" id="nav-dashboard" class="nav-btn active px-4 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-chart-pie mr-1"></i> æ•°æ®æ€»è§ˆ
                </button>
                <button onclick="window.switchTab('students')" id="nav-students" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-users mr-1"></i> å­¦ç”Ÿè¯¦æƒ…åˆ—è¡¨
                </button>
            </div>
        </div>
        <div class="text-xs text-slate-500 flex items-center gap-2" id="status-indicator">
            <span class="w-2 h-2 rounded-full bg-red-500"></span> ç¦»çº¿
        </div>
    </header>

    <!-- 3. ä¸»å†…å®¹åŒº -->
    <main class="flex-1 overflow-hidden relative">
        
        <!-- è§†å›¾ A: æ•°æ®æ€»è§ˆ (Dashboard) -->
        <div id="view-dashboard" class="absolute inset-0 p-6 overflow-y-auto custom-scroll grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
            <div class="lg:col-span-12 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 rounded-xl">
                    <div class="text-slate-400 text-xs font-bold uppercase">æäº¤äººæ•°</div>
                    <div class="text-3xl font-mono font-bold text-white mt-1" id="stat-count">0</div>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <div class="text-slate-400 text-xs font-bold uppercase">AI äº¤äº’æ€»é‡</div>
                    <div class="text-3xl font-mono font-bold text-purple-400 mt-1" id="stat-ai">0</div>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <div class="text-slate-400 text-xs font-bold uppercase">å¤åˆ¶/ç²˜è´´æ¬¡æ•°</div>
                    <div class="text-3xl font-mono font-bold text-orange-400 mt-1" id="stat-copy">0</div>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <div class="text-slate-400 text-xs font-bold uppercase">å¹³å‡ç­”é¢˜æ—¶é•¿</div>
                    <div class="text-3xl font-mono font-bold text-blue-400 mt-1" id="stat-time">0m</div>
                </div>
            </div>

            <!-- å›¾è¡¨ -->
            <div class="lg:col-span-8 glass-panel p-6 rounded-xl flex flex-col">
                <h3 class="font-bold text-white mb-4"><i class="fa-solid fa-chart-column text-blue-500 mr-2"></i>å…¨ç­è¡Œä¸ºæ¨¡å¼åˆ†å¸ƒ</h3>
                <div class="chart-wrapper flex-1">
                    <canvas id="behaviorChart"></canvas>
                </div>
            </div>

            <!-- ç®€æŠ¥ -->
            <div class="lg:col-span-4 glass-panel p-6 rounded-xl">
                <h3 class="font-bold text-white mb-4"><i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>åˆ†æç®€æŠ¥</h3>
                <div class="space-y-4 text-sm text-slate-300">
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span>AI ä¾èµ–åº¦ (æé—®/é¢˜æ•°)</span>
                        <span class="font-bold text-purple-400" id="rate-ai">0%</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-700 pb-2">
                        <span>ç­”æ¡ˆæ¬è¿ç‡ (ç²˜è´´/é¢˜æ•°)</span>
                        <span class="font-bold text-orange-400" id="rate-paste">0%</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-4 leading-relaxed">
                        æ³¨æ„ï¼š<br>
                        â€¢ æ•°æ®ä»…ç»Ÿè®¡å½“å‰<b>åœ¨å†Œå­¦ç”Ÿ</b>ã€‚<br>
                        â€¢ åˆ é™¤å­¦ç”Ÿåï¼Œå…¶äº§ç”Ÿçš„æ‰€æœ‰æ•°æ®æŒ‡æ ‡å°†è‡ªåŠ¨ä»æ€»è§ˆä¸­æ‰£é™¤ã€‚<br>
                    </p>
                </div>
            </div>
        </div>

        <!-- è§†å›¾ B: å­¦ç”Ÿåˆ—è¡¨ (Student List) -->
        <div id="view-students" class="absolute inset-0 p-6 overflow-hidden hidden flex flex-col">
            <div class="glass-panel rounded-xl flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                    <h3 class="font-bold text-white">å·²æäº¤å­¦ç”Ÿåå•</h3>
                    <input type="text" id="student-search" oninput="window.renderStudentTable()" placeholder="æœç´¢å§“å..." class="bg-slate-900 border border-slate-700 rounded px-3 py-1 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div class="flex-1 overflow-auto custom-scroll">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-900 sticky top-0 z-10">
                            <tr>
                                <th class="p-4">å§“å</th>
                                <th class="p-4">æäº¤æ—¶é—´</th>
                                <th class="p-4">ç­”é¢˜æ—¶é•¿</th>
                                <th class="p-4">æ¥æº IP</th>
                                <th class="p-4 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="student-tbody" class="divide-y divide-slate-700/50">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 text-slate-200 rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden animate-fade-in">
            <!-- å¤´éƒ¨ -->
            <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                <div>
                    <h3 class="font-bold text-xl text-white" id="modal-name">å­¦ç”Ÿå§“å</h3>
                    <div class="flex gap-4 text-xs text-slate-500 mt-1">
                        <span id="modal-time">æäº¤æ—¶é—´: --</span>
                        <span id="modal-ip">IP: --</span>
                    </div>
                </div>
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg transition-colors">å…³é—­</button>
            </div>
            
            <!-- å†…å®¹ï¼šå·¦å³åˆ†æ  -->
            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
                <!-- å·¦ä¾§ï¼šç­”å·å†…å®¹ -->
                <div class="w-full lg:w-1/2 p-6 overflow-y-auto border-r border-slate-800 custom-scroll bg-slate-900">
                    <h4 class="font-bold text-blue-400 mb-4 sticky top-0 bg-slate-900 py-2 border-b border-slate-800 z-10">
                        <i class="fa-solid fa-file-pen mr-2"></i>ç­”å·å†…å®¹
                    </h4>
                    <div id="modal-answers" class="space-y-6"></div>
                </div>
                
                <!-- å³ä¾§ï¼šäº¤äº’å¤ç›˜ -->
                <div class="w-full lg:w-1/2 p-6 overflow-y-auto custom-scroll bg-slate-950">
                    <h4 class="font-bold text-purple-400 mb-4 sticky top-0 bg-slate-950 py-2 border-b border-slate-800 z-10">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i>å­¦ä¹ è·¯å¾„å¤ç›˜ (AI äº¤äº’æµ)
                    </h4>
                    <div id="modal-timeline" class="space-y-0 relative border-l-2 border-slate-800 ml-3 pl-6 pb-10">
                        <!-- JS å¡«å……æ—¶é—´è½´ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€»è¾‘ä»£ç  -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ğŸš¨ å¿…é¡»åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„é…ç½®ä¿¡æ¯ (GitHub Pages ä¸“ç”¨)
        // ==========================================
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyCjzR_Idy9h7AWHLRxz_bzt77i3iCInrU8",
          authDomain: "ai-and-education-47d62.firebaseapp.com",
          projectId: "ai-and-education-47d62",
          storageBucket: "ai-and-education-47d62.firebasestorage.app",
          messagingSenderId: "983382295554",
          appId: "1:983382295554:web:f65048ae253b284816131b",
          measurementId: "G-Z8S8D9YN6D"
        };
        // ==========================================

        let db;
        let auth;
        let chartInstance = null;
        let globalData = { submissions: [], logs: [] };
        let appId = "github-pages-v1";
        
        const QUESTIONS_COUNT = 5;

        // å…¨å±€æŒ‚è½½
        window.checkPassword = function() {
            if(document.getElementById('password-input').value === '1234') {
                document.getElementById('init-status').innerText = "æ­£åœ¨è¿æ¥æ•°æ®åº“...";
                init();
            } else { alert("å¯†ç é”™è¯¯"); }
        };
        document.getElementById('password-input').addEventListener('keydown', (e) => { if(e.key==='Enter') window.checkPassword(); });

        window.switchTab = function(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-blue-600', 'text-white'));
            document.getElementById(`nav-${tab}`).classList.add('active', 'bg-blue-600', 'text-white');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-students').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };

        window.renderStudentTable = function() {
            const tbody = document.getElementById('student-tbody');
            const search = document.getElementById('student-search').value.toLowerCase();
            tbody.innerHTML = '';
            const filtered = globalData.submissions.filter(s => s.studentName.toLowerCase().includes(search));
            filtered.forEach((data, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800 transition-colors border-b border-slate-800";
                const timeStr = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const duration = `${Math.floor(data.totalTimeSeconds/60)}åˆ†${data.totalTimeSeconds%60}ç§’`;
                tr.innerHTML = `
                    <td class="p-4 font-bold text-white">${data.studentName}</td>
                    <td class="p-4 text-slate-400 text-xs">${timeStr}</td>
                    <td class="p-4 font-mono text-blue-400 text-xs">${duration}</td>
                    <td class="p-4 font-mono text-slate-500 text-xs">${data.ipAddress || 'Unknown'}</td>
                    <td class="p-4 text-right flex gap-2 justify-end">
                        <button onclick="window.openDetails('${data.userId}')" class="bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-1.5 rounded text-xs transition-all border border-blue-600/30">è¯¦æƒ…</button>
                        <button onclick="window.deleteStudent('${data.docId}', '${data.studentName}')" class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1.5 rounded text-xs transition-all border border-red-600/30"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.deleteStudent = async function(docId, name) {
            if(!confirm(`åˆ é™¤å­¦ç”Ÿ "${name}" çš„æ‰€æœ‰è®°å½•ï¼Ÿ`)) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions_v2', docId)); } catch(e) { alert("åˆ é™¤å¤±è´¥"); }
        };

        window.openDetails = async function(userId) {
            const subData = globalData.submissions.find(s => s.userId === userId);
            if (!subData) return;
            document.getElementById('modal-name').innerText = subData.studentName;
            document.getElementById('modal-time').innerText = `æäº¤: ${new Date(subData.timestamp.seconds*1000).toLocaleString()}`;
            document.getElementById('modal-ip').innerText = `IP: ${subData.ipAddress || 'N/A'}`;
            const ansContainer = document.getElementById('modal-answers');
            ansContainer.innerHTML = '';
            subData.details.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-slate-800 rounded-lg p-4 border border-slate-700";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2"><span class="text-blue-400 font-bold text-sm">Q${item.qNum}</span><span class="text-xs text-slate-500 font-mono">${Math.floor(item.durationMs/1000)}s</span></div>
                    <p class="text-xs text-slate-400 mb-3">${item.question}</p>
                    <div class="bg-slate-900 p-3 rounded text-sm text-slate-200 border border-slate-800 whitespace-pre-wrap">${item.answer}</div>
                `;
                ansContainer.appendChild(div);
            });
            const tlContainer = document.getElementById('modal-timeline');
            tlContainer.innerHTML = '';
            const userLogs = globalData.logs.filter(l => l.userId === userId).sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
            if (userLogs.length === 0) { tlContainer.innerHTML = '<div class="text-slate-500 text-sm italic">æ—  AI äº¤äº’è®°å½•</div>'; } 
            else {
                userLogs.forEach(log => {
                    const time = new Date(log.timestamp.seconds*1000).toLocaleTimeString();
                    let icon = 'fa-comment', color = 'text-slate-400', title = 'æ“ä½œ';
                    if (log.type.includes('chat_user')) { icon = 'fa-paper-plane'; color = 'text-blue-400'; title = "æé—® AI"; }
                    else if (log.type.includes('chat_ai')) { icon = 'fa-robot'; color = 'text-purple-400'; title = "AI å›å¤"; }
                    else if (log.type === 'copy') { icon = 'fa-copy'; color = 'text-orange-400'; title = "å¤åˆ¶"; }
                    else if (log.type === 'paste') { icon = 'fa-paste'; color = 'text-green-400'; title = "ç²˜è´´"; }
                    const item = document.createElement('div');
                    item.className = "mb-6 relative";
                    item.innerHTML = `
                        <div class="absolute -left-[33px] bg-slate-900 border border-slate-700 rounded-full w-8 h-8 flex items-center justify-center ${color}"><i class="fa-solid ${icon} text-xs"></i></div>
                        <div class="bg-slate-900 border border-slate-800 rounded-lg p-3 shadow-sm"><div class="flex justify-between items-center mb-1"><span class="text-xs font-bold ${color}">${title}</span><span class="text-[10px] text-slate-600 font-mono">${time}</span></div><p class="text-xs text-slate-400 leading-relaxed whitespace-pre-wrap break-all">${log.content}</p></div>
                    `;
                    tlContainer.appendChild(item);
                });
            }
            document.getElementById('details-modal').classList.remove('hidden');
        };

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                if (FIREBASE_CONFIG.apiKey === "AIzaSy...") {
                    alert("è¯·åœ¨ä»£ç ä¸­é…ç½® Firebase Configï¼");
                    return;
                }
                const app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        document.getElementById('lock-screen').classList.add('hidden');
                        document.getElementById('status-indicator').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> å®æ—¶åŒæ­¥';
                        startListening();
                    }
                });
            } catch(e) {
                console.error(e);
                alert("è¿æ¥æ•°æ®åº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®");
            }
        }

        function startListening() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'submissions_v2'), orderBy('timestamp', 'desc')), (snap) => {
                globalData.submissions = [];
                snap.forEach(docSnap => globalData.submissions.push({ docId: docSnap.id, ...docSnap.data() }));
                updateDashboard();
                window.renderStudentTable();
            });
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'chat_logs')), (snap) => {
                globalData.logs = [];
                snap.forEach(docSnap => globalData.logs.push(docSnap.data()));
                updateDashboard();
            });
        }

        function updateDashboard() {
            const activeUserIds = new Set(globalData.submissions.map(s => s.userId));
            const activeLogs = globalData.logs.filter(l => activeUserIds.has(l.userId));
            const subCount = globalData.submissions.length;
            let stats = { ai: 0, copy: 0, paste: 0 };
            activeLogs.forEach(l => {
                if(l.type.includes('chat_user')) stats.ai++;
                if(l.type === 'copy') stats.copy++;
                if(l.type === 'paste') stats.paste++;
            });
            const totalTime = globalData.submissions.reduce((a, b) => a + (b.totalTimeSeconds || 0), 0);
            const avgTime = subCount ? Math.floor(totalTime / subCount) : 0;
            document.getElementById('stat-count').innerText = subCount;
            document.getElementById('stat-ai').innerText = stats.ai;
            document.getElementById('stat-copy').innerText = stats.copy + stats.paste;
            document.getElementById('stat-time').innerText = `${Math.floor(avgTime/60)}m ${avgTime%60}s`;
            const totalQuestions = (subCount || 1) * QUESTIONS_COUNT;
            const aiRate = (stats.ai / totalQuestions) * 100;
            const pasteRate = (stats.paste / totalQuestions) * 100;
            document.getElementById('rate-ai').innerText = aiRate.toFixed(1) + '%';
            document.getElementById('rate-paste').innerText = pasteRate.toFixed(1) + '%';
            const ctx = document.getElementById('behaviorChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['AI æé—®é¢‘ç‡', 'ç­”æ¡ˆæ¬è¿é¢‘ç‡'],
                    datasets: [{ label: 'ç™¾åˆ†æ¯” (%)', data: [aiRate, pasteRate], backgroundColor: ['rgba(168, 85, 247, 0.6)', 'rgba(249, 115, 22, 0.6)'], borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>

