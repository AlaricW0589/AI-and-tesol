<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认知评估研究控制台 | Admin Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-regression-trendline@2.0.3/dist/chartjs-plugin-regression-trendline.min.js"></script>

    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* 登录遮罩动画 */
       .fade-out { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        
        /* 玻璃拟态面板 */
       .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen overflow-hidden flex flex-col">

    <div id="lock-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center transition-all duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">研究员登录</h2>
            <p class="text-sm text-slate-500 mb-6">请输入访问密钥以管理题库与数据</p>
            <input type="password" id="password-input" class="w-full px-4 py-3 rounded-lg border border-slate-300 mb-4 focus:ring-2 focus:ring-blue-500 outline-none text-center tracking-widest" placeholder="••••">
            <button onclick="AuthSystem.login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                进入系统
            </button>
            <p id="login-msg" class="text-red-500 text-xs mt-4 h-4"></p>
        </div>
    </div>

    <div id="app-container" class="flex flex-1 h-full overflow-hidden opacity-0 transition-opacity duration-500">
        
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">R</div>
                <span class="font-bold text-white tracking-wide">Research<span class="font-normal text-slate-500">Hub</span></span>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="UI.switchTab('questions')" id="nav-questions" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-blue-400 bg-slate-800">
                    <i class="fa-solid fa-database w-5"></i> 题库标定
                </button>
                <button onclick="UI.switchTab('analytics')" id="nav-analytics" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-chart-line w-5"></i> 犹豫行为分析
                </button>
                <button onclick="UI.switchTab('monitor')" id="nav-monitor" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3">
                    <i class="fa-solid fa-users-viewfinder w-5"></i> 实时监考
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                <p>Status: <span id="connection-status" class="text-green-500">● Online</span></p>
                <p class="mt-1">v2.1.0 (IRT Enabled)</p>
            </div>
        </aside>

        <main class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col">
            
            <header class="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-8 shadow-sm z-10">
                <h1 id="page-title" class="text-xl font-bold text-slate-800">心理测量学题库管理</h1>
                <div class="flex gap-4">
                    <button class="text-slate-400 hover:text-blue-600 transition-colors"><i class="fa-solid fa-bell"></i></button>
                    <button class="text-slate-400 hover:text-red-600 transition-colors" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
                
                <section id="view-questions" class="space-y-6 max-w-6xl mx-auto animate-fade-in">
                    <div class="glass-panel p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-slate-700"><i class="fa-solid fa-plus-circle mr-2 text-blue-600"></i>录入新试题</h3>
                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100">支持 Markdown</span>
                        </div>
                        
                        <form id="question-form" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">题干内容 (Stem)</label>
                                <textarea id="input-stem" rows="3" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="请输入题目描述..."></textarea>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bloom's Taxonomy</label>
                                    <select id="input-bloom" class="w-full p-2 rounded border border-slate-300 text-sm">
                                        <option value="Remember">记忆 (Remember)</option>
                                        <option value="Understand">理解 (Understand)</option>
                                        <option value="Apply">应用 (Apply)</option>
                                        <option value="Analyze">分析 (Analyze)</option>
                                        <option value="Evaluate">评价 (Evaluate)</option>
                                        <option value="Create">创造 (Create)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IRT 难度 (b)</label>
                                    <input type="number" id="input-difficulty" step="0.1" min="-3" max="3" value="0.0" class="w-full p-2 rounded border border-slate-300 text-sm">
                                    <p class="text-[10px] text-slate-400 mt-1">-3.0 (易) ~ +3.0 (难)</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">IRT 区分度 (a)</label>
                                    <input type="number" id="input-discrimination" step="0.1" min="0" max="3" value="1.0" class="w-full p-2 rounded border border-slate-300 text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">选项设定 (点击圆点标记正确答案)</label>
                                <div id="options-list" class="space-y-2">
                                    </div>
                                <button type="button" onclick="QuestionManager.addOptionField()" class="mt-2 text-xs text-blue-600 hover:underline">+ 添加选项</button>
                            </div>

                            <div class="pt-4 border-t border-slate-100 flex justify-end">
                                <button type="button" onclick="QuestionManager.submit()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-slate-300 transition-transform active:scale-95">
                                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i>录入数据库
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="glass-panel p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-700">题库列表 (<span id="q-count">0</span>)</h3>
                            <input type="text" id="search-q" placeholder="搜索题目..." class="px-3 py-1 rounded border border-slate-300 text-sm">
                        </div>
                        <div id="questions-container" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                            </div>
                    </div>
                </section>

                <section id="view-analytics" class="hidden space-y-6 max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <p class="text-xs text-slate-400 uppercase">总样本量 (Session)</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-sessions">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                            <p class="text-xs text-slate-400 uppercase">平均犹豫熵 (Entropy)</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-entropy">0.00 bits</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
                            <p class="text-xs text-slate-400 uppercase">答案修改率 (Switch Rate)</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-switch">0%</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                            <p class="text-xs text-slate-400 uppercase">快速猜测剔除数</p>
                            <p class="text-2xl font-bold text-slate-800" id="stat-invalid">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm h-[400px] flex flex-col">
                            <h3 class="text-sm font-bold text-slate-700 mb-4 flex justify-between">
                                <span><i class="fa-solid fa-arrow-trend-up mr-2 text-blue-500"></i>难度 vs. 犹豫 (Yerkes-Dodson Law)</span>
                                <span class="text-xs text-slate-400 font-normal">多项式回归拟合 (Degree 2)</span>
                            </h3>
                            <div class="flex-1 relative">
                                <canvas id="chart-yerkes"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm h-[400px] flex flex-col">
                            <h3 class="text-sm font-bold text-slate-700 mb-4">
                                <span><i class="fa-solid fa-layer-group mr-2 text-purple-500"></i>Bloom认知层级犹豫分布</span>
                            </h3>
                            <div class="flex-1 relative">
                                <canvas id="chart-bloom"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="view-monitor" class="hidden">
                    <div class="bg-white p-10 rounded-xl text-center text-slate-400">
                        <i class="fa-solid fa-wrench text-4xl mb-4"></i>
                        <p>实时监控模块开发中...</p>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 配置区域 (PLACEHOLDERS) ---
        // 请在此处替换为您的 Firebase 项目配置
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375",
            measurementId: "G-ZNZ14Q5R98"
        };

        // --- 全局状态 ---
        const state = {
            app: null,
            db: null,
            user: null,
            questions:, // 缓存题库
            sessions:,  // 缓存考试记录
            charts: {}     // Chart.js 实例
        };

        // --- 1. 认证与初始化系统 ---
        const AuthSystem = {
            async init() {
                try {
                    state.app = initializeApp(firebaseConfig);
                    state.db = getFirestore(state.app);
                    const auth = getAuth(state.app);
                    
                    // 匿名登录 (延续旧版逻辑)
                    const userCred = await signInAnonymously(auth);
                    state.user = userCred.user;
                    console.log("Admin Logged In:", state.user.uid);
                    
                    // 启动监听
                    DataService.listenQuestions();
                    DataService.listenSessions();

                } catch (e) {
                    console.error("Init Failed", e);
                    alert("连接数据库失败，请检查控制台");
                }
            },

            login() {
                const pwd = document.getElementById('password-input').value;
                if (pwd === '1234') { // 硬编码密码 (延续旧版)
                    document.getElementById('lock-screen').classList.add('fade-out');
                    document.getElementById('app-container').classList.remove('opacity-0');
                    this.init();
                } else {
                    document.getElementById('login-msg').innerText = "密码错误";
                    document.getElementById('password-input').value = '';
                }
            }
        };

        // --- 2. 数据服务层 (Firebase CRUD) ---
        const DataService = {
            getPath(coll) {
                return `artifacts/${firebaseConfig.appId}/public/data/${coll}`;
            },

            listenQuestions() {
                const q = query(collection(state.db, this.getPath('question_bank')), orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    state.questions = snapshot.docs.map(d => ({ id: d.id,...d.data() }));
                    UI.renderQuestionList();
                    AnalyticsEngine.update(); // 数据变动时刷新图表
                });
            },

            listenSessions() {
                // 监听考试结果 (interaction logs)
                const q = query(collection(state.db, this.getPath('exam_results')), orderBy('submittedAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    state.sessions = snapshot.docs.map(d => ({ id: d.id,...d.data() }));
                    AnalyticsEngine.update(); // 数据变动时刷新图表
                });
            },

            async addQuestion(data) {
                await addDoc(collection(state.db, this.getPath('question_bank')), data);
            },

            async deleteQuestion(id) {
                if(confirm("确定删除此题及其历史数据吗？")) {
                    await deleteDoc(doc(state.db, this.getPath('question_bank'), id));
                }
            }
        };

        // --- 3. 题库管理器逻辑 ---
        const QuestionManager = {
            options:, // 默认两个选项

            init() {
                this.renderOptions();
            },

            addOptionField() {
                if (this.options.length >= 6) return;
                const nextChar = String.fromCharCode(65 + this.options.length);
                this.options.push(nextChar);
                this.renderOptions();
            },

            removeOptionField(idx) {
                if (this.options.length <= 2) return;
                this.options.splice(idx, 1);
                this.renderOptions();
            },

            renderOptions() {
                const container = document.getElementById('options-list');
                container.innerHTML = '';
                this.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="radio" name="correct-opt" value="${idx}" ${idx===0?'checked':''} class="w-4 h-4 text-blue-600">
                        <input type="text" data-idx="${idx}" class="opt-text flex-1 px-3 py-2 rounded border border-slate-200 text-sm focus:border-blue-500 outline-none" placeholder="选项 ${String.fromCharCode(65+idx)}">
                        ${this.options.length > 2? `<button type="button" onclick="window.removeOpt(${idx})" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>` : ''}
                    `;
                    container.appendChild(div);
                });
            },

            async submit() {
                const stem = document.getElementById('input-stem').value.trim();
                if (!stem) return alert("题干不能为空");

                // 收集选项
                const optInputs = document.querySelectorAll('.opt-text');
                const optionsList =;
                let hasEmpty = false;
                optInputs.forEach((input, i) => {
                    const val = input.value.trim();
                    if (!val) hasEmpty = true;
                    optionsList.push(val);
                });
                if (hasEmpty) return alert("请填写所有选项内容");

                // 获取正确答案索引
                const correctIdx = document.querySelector('input[name="correct-opt"]:checked').value;

                // 构建符合研究设计的数据包
                const payload = {
                    text: stem,
                    options: optionsList,
                    correctIndex: parseInt(correctIdx),
                    
                    // 心理测量元数据
                    metadata: {
                        bloom: document.getElementById('input-bloom').value,
                        difficulty_b: parseFloat(document.getElementById('input-difficulty').value),
                        discrimination_a: parseFloat(document.getElementById('input-discrimination').value)
                    },
                    
                    timestamp: serverTimestamp()
                };

                try {
                    await DataService.addQuestion(payload);
                    // 重置表单
                    document.getElementById('input-stem').value = '';
                    document.querySelectorAll('.opt-text').forEach(i => i.value = '');
                    alert("✅ 题目已录入");
                } catch (e) {
                    console.error(e);
                    alert("录入失败");
                }
            }
        };

        // --- 4. 犹豫分析引擎 (核心研究部分) ---
        const AnalyticsEngine = {
            // 计算香农熵 (简化版: 基于点击分布或假设的轨迹复杂度)
            // 在真实场景中，这需要解析后端存储的鼠标坐标数组
            calculateEntropy(behaviorMetrics) {
                // 这里使用 Change Count 作为熵的代理变量进行演示
                // H ≈ log2(Changes + 1)
                return Math.log2((behaviorMetrics.answerChangeCount |

| 0) + 1).toFixed(2);
            },

            // 计算犹豫指数 (Hesitation Index)
            // HI = 0.5*Norm(Time) + 0.3*Switch + 0.2*Entropy
            calculateHI(metric, durationMs) {
                const normTime = Math.min(durationMs / 60000, 1); // 归一化时间 (max 60s)
                const switches = Math.min((metric.answerChangeCount |

| 0) / 5, 1);
                return (0.6 * normTime + 0.4 * switches).toFixed(2);
            },

            update() {
                if (!state.sessions.length ||!state.questions.length) return;

                let totalEntropy = 0;
                let totalSwitches = 0;
                let validCount = 0;
                let invalidCount = 0; // 快速猜测

                const plotPoints =; // {x: difficulty, y: hesitation}
                const bloomStats = {}; // {Analyze: [HI, HI...]}

                state.sessions.forEach(session => {
                    session.answers.forEach(ans => {
                        // 1. 数据清洗 (剔除 < 3秒的快速猜测)
                        if (ans.behaviorMetrics.totalDuration < 3000) {
                            invalidCount++;
                            return;
                        }

                        // 2. 关联题目元数据
                        const question = state.questions.find(q => q.id === ans.questionId);
                        if (!question) return;

                        // 3. 计算指标
                        const entropy = parseFloat(this.calculateEntropy(ans.behaviorMetrics));
                        const hi = parseFloat(this.calculateHI(ans.behaviorMetrics, ans.behaviorMetrics.totalDuration));

                        totalEntropy += entropy;
                        totalSwitches += (ans.behaviorMetrics.answerChangeCount |

| 0);
                        validCount++;

                        // 4. 收集图表数据
                        // 散点图数据: X=难度, Y=犹豫指数
                        plotPoints.push({
                            x: question.metadata.difficulty_b,
                            y: hi
                        });

                        // Bloom分类数据
                        const bloom = question.metadata.bloom;
                        if (!bloomStats[bloom]) bloomStats[bloom] =;
                        bloomStats[bloom].push(hi);
                    });
                });

                // 更新仪表盘数字
                document.getElementById('stat-sessions').innerText = state.sessions.length;
                document.getElementById('stat-entropy').innerText = validCount? (totalEntropy / validCount).toFixed(2) + ' bits' : '0';
                document.getElementById('stat-switch').innerText = validCount? (totalSwitches / validCount).toFixed(1) : '0';
                document.getElementById('stat-invalid').innerText = invalidCount;

                this.renderYerkesChart(plotPoints);
                this.renderBloomChart(bloomStats);
            },

            renderYerkesChart(dataPoints) {
                const ctx = document.getElementById('chart-yerkes').getContext('2d');
                
                if (state.charts.yerkes) state.charts.yerkes.destroy();

                state.charts.yerkes = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets:
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: '试题难度 (IRT b)' }, min: -3, max: 3 },
                            y: { title: { display: true, text: '犹豫指数 (HI)' }, min: 0, max: 1 }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `Diff: ${ctx.parsed.x}, HI: ${ctx.parsed.y}`
                                }
                            }
                        }
                    }
                });
            },

            renderBloomChart(stats) {
                const ctx = document.getElementById('chart-bloom').getContext('2d');
                const labels =;
                const data = labels.map(l => {
                    const arr = stats[l] ||;
                    return arr.length? (arr.reduce((a,b)=>a+b,0) / arr.length) : 0;
                });

                if (state.charts.bloom) state.charts.bloom.destroy();

                state.charts.bloom = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '平均犹豫指数',
                            data: data,
                            backgroundColor: [
                                '#fcd34d', '#fbbf24', '#f59e0b', '#d97706', '#b45309', '#78350f'
                            ],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 1 } }
                    }
                });
            }
        };

        // --- 5. UI 控制 ---
        const UI = {
            switchTab(tabName) {
                // 隐藏所有 View
                document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
                // 显示当前 View
                document.getElementById(`view-${tabName}`).classList.remove('hidden');
                
                // 更新按钮状态
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.remove('text-blue-400', 'bg-slate-800');
                    if (btn.id === `nav-${tabName}`) btn.classList.add('text-blue-400', 'bg-slate-800');
                });

                // 更新标题
                const titles = {
                    questions: '心理测量学题库管理',
                    analytics: '犹豫行为与认知交互分析',
                    monitor: '实时考场监控'
                };
                document.getElementById('page-title').innerText = titles[tabName];
                
                // 如果切换到分析页，强制刷新一次图表
                if(tabName === 'analytics') AnalyticsEngine.update();
            },

            renderQuestionList() {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                
                state.questions.forEach(q => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded border border-slate-100 flex justify-between items-start group hover:shadow-md transition-shadow';
                    
                    // 认知标签颜色
                    const bloomColor = {
                        'Remember': 'bg-yellow-100 text-yellow-700',
                        'Analyze': 'bg-purple-100 text-purple-700',
                        'Evaluate': 'bg-red-100 text-red-700'
                    }[q.metadata.bloom] |

| 'bg-slate-100 text-slate-600';

                    el.innerHTML = `
                        <div>
                            <div class="flex gap-2 mb-2">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded ${bloomColor}">${q.metadata.bloom}</span>
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-600">b=${q.metadata.difficulty_b}</span>
                            </div>
                            <p class="text-sm text-slate-700 font-medium">${q.text}</p>
                            <p class="text-xs text-slate-400 mt-1">选项: ${q.options.join(' / ')}</p>
                        </div>
                        <button onclick="window.delQ('${q.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(el);
                });
                document.getElementById('q-count').innerText = state.questions.length;
            }
        };

        // --- 全局暴露 (用于 HTML onclick) ---
        window.AuthSystem = AuthSystem;
        window.QuestionManager = QuestionManager;
        window.UI = UI;
        
        // 辅助：删除选项行
        window.removeOpt = (idx) => QuestionManager.removeOptionField(idx);
        // 辅助：删除题目
        window.delQ = (id) => DataService.deleteQuestion(id);

        // 初始化选项
        QuestionManager.init();

    </script>
</body>
</html>
