<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Reading Assessment - Research Environment</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <script type="module">
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js](https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js)";
        import { getFirestore, doc, setDoc, serverTimestamp } from "[https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js)";
        import { getAuth, signInAnonymously } from "[https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js](https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js)";

        // --- 配置区域 (请替换为您的 Firebase 项目配置) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375"
            measurementId: "G-ZNZ14Q5R98"
        };

        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- 全局状态管理 ---
        const state = {
            user: null,
            studentInfo: {},
            currentQuestionIndex: 0,
            questions:,
                    bloom: "Analyze",
                    difficulty_b: 0.8
                },
                {
                    id: "q2_detail",
                    text: "Passage: In 1928, Alexander Fleming discovered penicillin, the first true antibiotic, by accident. He noticed that a mold called Penicillium notatum had contaminated his Petri dishes and killed the Staphylococcus bacteria he was cultivating.<br><br>Question: What was the name of the mold discovered by Fleming?",
                    options:,
                    bloom: "Remember",
                    difficulty_b: -1.2
                }
            ],
            answersLog:, // 存储所有答题数据
            sessionStart: null,
            
            // 当前题目的临时数据
            currentMetrics: {
                startTime: 0,
                firstClickTime: null,
                changeCount: 0,
                trajectory:, // 鼠标轨迹 [(x,y,t)...]
                hovers: {},     // 悬停数据 {optionIdx: {count, duration}}
                offTask:     // 切屏记录
            }
        };

        // --- 工具类：高频轨迹记录器 (Trace Recorder) ---
        class TraceRecorder {
            constructor() {
                this.isRecording = false;
                this.throttleTime = 50; // 采样间隔 50ms (20Hz)
                this.lastRecordTime = 0;
            }

            start() {
                this.isRecording = true;
                state.currentMetrics.trajectory =;
                // 记录初始位置 (归一化)
                this.recordPoint(lastMouseX, lastMouseY); 
            }

            stop() {
                this.isRecording = false;
            }

            // 节流记录函数
            record(x, y) {
                if (!this.isRecording) return;
                const now = Date.now();
                if (now - this.lastRecordTime > this.throttleTime) {
                    this.recordPoint(x, y, now);
                    this.lastRecordTime = now;
                }
            }

            recordPoint(x, y, time = Date.now()) {
                // 坐标归一化：保留4位小数，节省存储空间
                // x_norm = x / window_width
                const xNorm = parseFloat((x / window.innerWidth).toFixed(4));
                const yNorm = parseFloat((y / window.innerHeight).toFixed(4));
                
                // 相对时间：相对于题目开始的时间 (ms)
                const tRel = time - state.currentMetrics.startTime;

                state.currentMetrics.trajectory.push();
            }
        }

        // --- 工具类：交互监控器 (Interaction Monitor) ---
        class InteractionMonitor {
            constructor() {
                this.hoverStartTime = null;
                this.currentHoverTarget = null;
                this.offTaskStartTime = null;
            }

            // 开始监听选项悬停
            monitorOption(element, optionIndex) {
                element.addEventListener('mouseenter', () => {
                    this.hoverStartTime = Date.now();
                    this.currentHoverTarget = optionIndex;
                });

                element.addEventListener('mouseleave', () => {
                    if (this.hoverStartTime) {
                        const duration = Date.now() - this.hoverStartTime;
                        
                        // 初始化数据结构
                        if (!state.currentMetrics.hovers[optionIndex]) {
                            state.currentMetrics.hovers[optionIndex] = { count: 0, totalDuration: 0 };
                        }
                        
                        state.currentMetrics.hovers[optionIndex].count++;
                        state.currentMetrics.hovers[optionIndex].totalDuration += duration;
                        
                        this.hoverStartTime = null;
                        this.currentHoverTarget = null;
                    }
                });
            }

            // 监听页面可见性（防作弊/专注度检测）
            initVisibilityMonitor() {
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) {
                        this.offTaskStartTime = Date.now();
                        console.log("User switched tab/minimized");
                    } else {
                        if (this.offTaskStartTime) {
                            const duration = Date.now() - this.offTaskStartTime;
                            const tRel = this.offTaskStartTime - state.currentMetrics.startTime;
                            
                            state.currentMetrics.offTask.push({
                                start_rel: tRel,
                                duration: duration
                            });
                            this.offTaskStartTime = null;
                        }
                    }
                });
            }
            
            // 触摸屏检测（控制变量）
            initTouchDetection() {
                window.addEventListener('touchstart', () => {
                    if(!state.studentInfo.hasTouchEvents) {
                         state.studentInfo.hasTouchEvents = true;
                         // 在控制台标记，或者在数据中标记“设备违规”
                         console.warn("Touch event detected. Valid research requires a mouse.");
                    }
                });
            }
        }

        const tracer = new TraceRecorder();
        const monitor = new InteractionMonitor();
        let lastMouseX = 0, lastMouseY = 0;

        // 全局鼠标移动监听 (用于轨迹)
        document.addEventListener('mousemove', (e) => {
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            tracer.record(e.clientX, e.clientY);
        });

        // 页面加载初始化
        window.initApp = async () => {
            try {
                await signInAnonymously(auth);
                state.user = auth.currentUser;
                monitor.initVisibilityMonitor();
                monitor.initTouchDetection();
                
                // 检查屏幕分辨率
                checkEnvironment();
            } catch (error) {
                console.error("Auth error:", error);
                alert("System init failed. Please check console.");
            }
        };

        // --- 视图控制逻辑 ---

        // 1. 环境检查
        function checkEnvironment() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const envStatus = document.getElementById('env-status');
            const startBtn = document.getElementById('btn-env-pass');

            let msg = `Detected Resolution: ${width}x${height}. `;
            let passed = true;

            if (width < 1024) {
                msg += "⚠️ Screen width is too small. Please use a laptop or desktop computer.";
                passed = false;
            } else {
                msg += "✅ Resolution OK.";
            }

            envStatus.innerText = msg;
            if(passed) startBtn.disabled = false;
        }

        // 2. 登录与开始
        window.startExam = () => {
            const name = document.getElementById('input-name').value;
            const id = document.getElementById('input-id').value;
            if (!name ||!id) return alert("Please enter Name and Student ID.");

            state.studentInfo = { name, id, deviceWidth: window.innerWidth, hasTouchEvents: false };
            state.sessionStart = Date.now();

            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            
            renderQuestion();
        };

        // 3. 渲染题目
        function renderQuestion() {
            const qIndex = state.currentQuestionIndex;
            const qData = state.questions[qIndex];

            // 重置单题指标
            state.currentMetrics = {
                startTime: Date.now(),
                firstClickTime: null,
                changeCount: 0,
                trajectory:,
                hovers: {},
                offTask:,
                selectedOption: null
            };
            
            // 开启轨迹记录
            tracer.start();

            // 更新 UI
            document.getElementById('question-progress').innerText = `Question ${qIndex + 1} / ${state.questions.length}`;
            document.getElementById('question-text').innerHTML = qData.text;

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-card p-4 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors mb-3';
                btn.innerText = opt;
                btn.id = `opt-${idx}`;
                
                // 绑定点击事件 (核心犹豫指标：初次反应时、修改次数)
                btn.onclick = () => handleOptionSelect(idx, opt);
                
                // 绑定悬停事件 (微观犹豫指标)
                monitor.monitorOption(btn, idx);

                optionsContainer.appendChild(btn);
            });
            
            // 禁用提交按钮直到做出选择
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').classList.add('opacity-50');
        }

        // 4. 处理选项点击
        function handleOptionSelect(idx, text) {
            const now = Date.now();
            
            // 记录初次反应时间
            if (state.currentMetrics.firstClickTime === null) {
                state.currentMetrics.firstClickTime = now - state.currentMetrics.startTime;
            } else {
                // 如果已经选过，且现在选了不一样的，增加“改变次数”
                if (state.currentMetrics.selectedOption!== idx) {
                    state.currentMetrics.changeCount++;
                }
            }

            state.currentMetrics.selectedOption = idx;
            state.currentMetrics.selectedText = text;

            // UI 反馈
            document.querySelectorAll('.option-card').forEach(d => {
                d.classList.remove('border-blue-500', 'bg-blue-50');
                d.classList.add('border-slate-200');
            });
            const selectedBtn = document.getElementById(`opt-${idx}`);
            selectedBtn.classList.remove('border-slate-200');
            selectedBtn.classList.add('border-blue-500', 'bg-blue-50');

            // 启用提交
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
        }

        // 5. 提交前检查 -> 进入元认知监测
        window.preSubmitCheck = () => {
            tracer.stop(); // 停止记录轨迹，防止Modal上的移动污染题目数据
            document.getElementById('confidence-modal').classList.remove('hidden');
        };

        // 6. 处理置信度并完成本题
        window.handleConfidence = (level) => {
            const now = Date.now();
            const qData = state.questions[state.currentQuestionIndex];

            // 构建完整的数据包 (Data Packet)
            const questionRecord = {
                questionId: qData.id,
                bloomLevel: qData.bloom,
                irtDifficulty: qData.difficulty_b,
                userAnswer: state.currentMetrics.selectedText,
                
                // 核心行为指标
                metrics: {
                    totalTime: now - state.currentMetrics.startTime,
                    firstClickTime: state.currentMetrics.firstClickTime,
                    changeCount: state.currentMetrics.changeCount,
                    confidence: level
                },
                
                // 微观过程数据 (Micro-process Data)
                processData: {
                    trajectory: state.currentMetrics.trajectory, // Array of [x,y,t]
                    hoverStats: state.currentMetrics.hovers,     // {opt: {count, duration}}
                    offTaskEvents: state.currentMetrics.offTask  // 切屏记录
                },
                
                timestamp: serverTimestamp()
            };

            state.answersLog.push(questionRecord);

            // UI 重置
            document.getElementById('confidence-modal').classList.add('hidden');
            state.currentQuestionIndex++;

            if (state.currentQuestionIndex < state.questions.length) {
                renderQuestion();
            } else {
                finishExam();
            }
        };

        // 7. 结束考试并上传
        async function finishExam() {
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');

            const totalTime = Date.now() - state.sessionStart;
            
            const sessionPayload = {
                student: state.studentInfo,
                sessionId: state.user.uid,
                startTime: new Date(state.sessionStart).toISOString(),
                endTime: new Date().toISOString(),
                totalSessionDuration: totalTime,
                answers: state.answersLog, // 包含所有轨迹的大型 JSON
                userAgent: navigator.userAgent
            };

            try {
                // 写入 Firestore
                await setDoc(doc(db, "exam_results", `${state.studentInfo.id}_${state.sessionStart}`), sessionPayload);
                
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('result-view').classList.remove('hidden');
            } catch (e) {
                console.error("Upload failed", e);
                alert("Upload failed. Please contact administrator.");
            }
        }

        // 启动
        window.onload = initApp;
    </script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
       .option-card { transition: all 0.2s; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center">

    <div id="setup-view" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold mb-4 text-slate-800">Research Assessment Setup</h1>
        
        <div class="mb-6 p-4 bg-yellow-50 text-yellow-800 text-sm rounded-lg border border-yellow-200">
            <strong>⚠️ Control Requirements:</strong>
            <ul class="list-disc ml-5 mt-2 space-y-1">
                <li>Please use a <strong>physical mouse</strong> (no trackpads).</li>
                <li>Maximize your browser to <strong>full screen</strong>.</li>
                <li>Do not switch tabs during the test.</li>
            </ul>
        </div>

        <div id="env-status" class="mb-4 text-xs text-slate-500 font-mono">Checking environment...</div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700">Student Name</label>
                <input id="input-name" type="text" class="mt-1 block w-full border border-slate-300 rounded-md p-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700">Student ID</label>
                <input id="input-id" type="text" class="mt-1 block w-full border border-slate-300 rounded-md p-2">
            </div>
            <button id="btn-env-pass" onclick="startExam()" disabled 
                class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 transition">
                Start Assessment
            </button>
        </div>
    </div>

    <div id="quiz-view" class="hidden w-full max-w-4xl h-full flex flex-col p-6">
        <div class="flex justify-between items-center mb-6">
            <span id="question-progress" class="text-slate-500 font-bold">Question 1</span>
            <div class="text-xs text-slate-400">Tracking Active</div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm flex-grow overflow-y-auto">
            <div id="question-text" class="text-lg text-slate-800 mb-8 leading-relaxed font-serif">
                </div>

            <div id="options-container" class="space-y-4">
                </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button id="submit-btn" onclick="preSubmitCheck()" disabled
                class="bg-emerald-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-emerald-700 transition shadow-lg opacity-50">
                Submit Answer
            </button>
        </div>
    </div>

    <div id="confidence-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full text-center">
            <h3 class="text-xl font-bold mb-4">Metacognitive Monitoring</h3>
            <p class="text-slate-600 mb-6">How confident are you in your answer?</p>
            
            <div class="grid grid-cols-5 gap-2 mb-2">
                <button onclick="handleConfidence(1)" class="p-3 border rounded hover:bg-red-50 hover:border-red-500 transition">1<br><span class="text-xs">Guessing</span></button>
                <button onclick="handleConfidence(2)" class="p-3 border rounded hover:bg-orange-50 hover:border-orange-500 transition">2<br><span class="text-xs">Unsure</span></button>
                <button onclick="handleConfidence(3)" class="p-3 border rounded hover:bg-yellow-50 hover:border-yellow-500 transition">3<br><span class="text-xs">Neutral</span></button>
                <button onclick="handleConfidence(4)" class="p-3 border rounded hover:bg-lime-50 hover:border-lime-500 transition">4<br><span class="text-xs">Likely</span></button>
                <button onclick="handleConfidence(5)" class="p-3 border rounded hover:bg-green-50 hover:border-green-500 transition">5<br><span class="text-xs">Certain</span></button>
            </div>
        </div>
    </div>

    <div id="loading-view" class="hidden text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-slate-600">Uploading behavioral data...</p>
    </div>

    <div id="result-view" class="hidden bg-white p-8 rounded-xl shadow-lg text-center max-w-md">
        <div class="text-5xl mb-4">✅</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Session Complete</h2>
        <p class="text-slate-600">Thank you for your participation. Your data has been securely recorded for analysis.</p>
        <p class="text-xs text-slate-400 mt-4">You may close this window.</p>
    </div>

</body>
</html>
