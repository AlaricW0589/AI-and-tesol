<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CET-6 阅读认知评估系统 | Research Client v2.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { clifford: '#da373d', } } }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* 反作弊机制：禁用文本选择和右键菜单，防止简单的复制搜索 */
       .unselectable {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 全屏强制遮罩层样式 */
        #fullscreen-warning {
            display: none; /* 默认隐藏 */
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.98); /* 深色背景阻断视觉 */
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        /* 平滑滚动体验 */
       .scroll-smooth {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden flex flex-col unselectable" oncontextmenu="return false;">

    <div id="fullscreen-warning">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md border-4 border-red-500 animate-pulse">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-red-600 text-3xl">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="text-2xl font-extrabold text-slate-800 mb-4">考试环境中断</h2>
            <p class="text-slate-600 mb-8 leading-relaxed">
                检测到全屏模式已退出。为了保证认知评估数据的有效性，系统已暂停记录。
                <br><span class="text-sm text-red-500 font-bold">请立即恢复全屏以继续作答。</span>
            </p>
            <button id="btn-resume-fs" class="w-full bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl font-bold transition shadow-lg text-lg flex items-center justify-center gap-2">
                <i class="fas fa-expand"></i> 恢复全屏模式
            </button>
        </div>
    </div>

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-30 flex-none">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-blue-200">
                <i class="fas fa-brain"></i>
            </div>
            <h1 class="text-lg font-bold text-slate-700 tracking-tight">
                深度阅读认知评估 
                <span class="text-xs text-slate-400 font-normal ml-2 font-mono">v2.4.0-Secure</span>
            </h1>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 px-3 py-1 bg-slate-50 rounded-full border border-slate-200">
                <div id="system-status-dot" class="w-2 h-2 rounded-full bg-slate-400 transition-colors duration-300"></div>
                <span id="system-status" class="text-xs font-medium text-slate-500">等待初始化</span>
            </div>
            <div class="text-slate-600 font-mono text-lg font-bold" id="timer">00:00</div>
            <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 border border-indigo-200">
                <i class="fas fa-user-graduate text-sm"></i>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <section id="reading-aoi" data-aoi="text" class="w-7/12 p-8 lg:p-12 overflow-y-auto relative scroll-smooth bg-[#fafafa]">
            <div class="max-w-3xl mx-auto bg-white shadow-sm p-10 min-h-full rounded-sm border border-slate-100 transition-all">
                <h1 id="passage-title" class="text-2xl font-bold text-slate-800 mb-6 font-serif border-b border-slate-100 pb-4">
                    <span class="inline-block w-4 h-4 border-2 border-slate-200 border-t-blue-600 rounded-full animate-spin mr-2"></span>
                    Loading Passage...
                </h1>
                <article id="passage-content" class="prose prose-slate lg:prose-lg max-w-none font-serif leading-loose text-slate-600">
                    </article>
            </div>
        </section>

        <section id="question-aoi" data-aoi="question" class="w-5/12 bg-white flex flex-col border-l border-slate-200 relative shadow-xl z-20">
            <div class="h-1 w-full bg-slate-100 flex-none">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-8 relative">
                <div class="mb-6 flex justify-between items-center">
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wider bg-blue-50 px-2 py-1 rounded border border-blue-100">
                        Question <span id="q-index">1</span>/<span id="q-total">--</span>
                    </span>
                </div>
                
                <h3 id="q-stem" class="text-lg font-medium text-slate-800 leading-relaxed mb-8">
                    </h3>
                
                <div id="options-list" class="space-y-3">
                    </div>
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end flex-none">
                <button id="btn-next" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-md shadow-blue-200 transition-all flex items-center gap-2 transform active:scale-95">
                    下一题 <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>
    </main>

    <div id="registration-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md border border-slate-200 relative overflow-hidden transform transition-all scale-100">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-1">实验注册</h2>
            <p class="text-slate-500 text-sm mb-6">Cognitive Hesitation Analysis - Participant Entry</p>
            
            <form id="reg-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">姓名 / Name</label>
                    <input type="text" id="reg-name" required placeholder="Pinyin or English" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">年龄 / Age</label>
                        <input type="number" id="reg-age" min="16" max="60" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-slate-50 focus:bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">年级 / Grade</label>
                        <select id="reg-grade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-slate-50 focus:bg-white">
                            <option value="Freshman">大一 (Freshman)</option>
                            <option value="Sophomore">大二 (Sophomore)</option>
                            <option value="Junior">大三 (Junior)</option>
                            <option value="Senior">大四 (Senior)</option>
                            <option value="Graduate">研究生 (Graduate)</option>
                        </select>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-xs text-slate-600 space-y-2 mt-4">
                    <p class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle mr-1"></i>数据采集声明</p>
                    <label class="flex items-start gap-2 cursor-pointer hover:text-blue-700 transition">
                        <input type="checkbox" required class="mt-0.5 rounded text-blue-600 focus:ring-blue-500">
                        <span>我确认当前环境安静，并同意全程开启全屏模式。</span>
                    </label>
                    <label class="flex items-start gap-2 cursor-pointer hover:text-blue-700 transition">
                        <input type="checkbox" required class="mt-0.5 rounded text-blue-600 focus:ring-blue-500">
                        <span>我同意系统记录我的鼠标轨迹用于认知科学研究。</span>
                    </label>
                </div>

                <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3.5 rounded-lg font-bold shadow-lg shadow-slate-200 transition-all mt-6 flex justify-center items-center gap-2 group">
                    <span>开始实验</span>
                    <i class="fas fa-chevron-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        // 引入 Firebase SDK (版本 v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. 基础配置 ---
        // 提取自原 index.html，保持项目配置一致性
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375",
            measurementId: "G-ZNZ14Q5R98"
        };

        /**
         * 认知评估追踪器类 (CognitiveTracker)
         * 封装了所有遥测、反作弊和数据传输逻辑
         */
        class CognitiveTracker {
            constructor() {
                // 初始化 Firebase
                this.app = initializeApp(firebaseConfig);
                this.db = getFirestore(this.app);

                // 会话状态
                this.sessionId = null;
                this.userId = null;
                this.isTracking = false;
                
                // 双重缓冲区
                this.mouseBuffer =; // 高频缓冲区：存储 30Hz 轨迹点
                this.eventBuffer =; // 事件缓冲区：存储点击、切屏等低频事件
                this.BUFFER_LIMIT = 50; // 自动刷新阈值 (约1.5秒数据量)
                
                // 性能节流参数 (30Hz)
                this.lastFrameTime = 0;
                this.targetFPS = 30;
                this.frameInterval = 1000 / this.targetFPS; // ~33.33ms

                // AOI 元素缓存
                this.aoiElements = {
                    text: document.getElementById('reading-aoi'),
                    question: document.getElementById('question-aoi')
                };

                this.bindEvents();
            }

            /**
             * 绑定所有全局事件监听器
             */
            bindEvents() {
                // 1. 启动 rAF 循环，用于高性能鼠标追踪
                this.rafId = requestAnimationFrame(this.trackingLoop.bind(this));

                // 2. 监听鼠标移动并缓存最新位置（解耦采样与事件触发）
                document.addEventListener('mousemove', (e) => this.cacheMousePosition(e));

                // 3. 反作弊监控
                document.addEventListener('visibilitychange', () => this.handleVisibility());
                document.addEventListener('fullscreenchange', () => this.handleFullscreen());

                // 4. 注册流程
                document.getElementById('reg-form').addEventListener('submit', (e) => this.handleRegistration(e));

                // 5. 全屏恢复
                document.getElementById('btn-resume-fs').addEventListener('click', () => {
                    this.enterFullscreen();
                    document.getElementById('fullscreen-warning').style.display = 'none';
                    this.logSystemEvent('FULLSCREEN_RESUME');
                });

                // 6. 页面卸载前的数据抢救 (Reliability)
                window.addEventListener('beforeunload', () => this.flushAllData(true));
            }

            /**
             * 处理用户注册与会话初始化
             */
            async handleRegistration(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 初始化中...';

                // 收集设备指纹，用于后续数据清洗
                const userData = {
                    name: document.getElementById('reg-name').value,
                    age: document.getElementById('reg-age').value,
                    grade: document.getElementById('reg-grade').value,
                    device: {
                        userAgent: navigator.userAgent,
                        screenWidth: window.screen.width,
                        screenHeight: window.screen.height,
                        pixelRatio: window.devicePixelRatio,
                        platform: navigator.platform
                    }
                };

                try {
                    // 创建会话文档
                    const sessionRef = await addDoc(collection(this.db, "sessions"), {
                        user: userData,
                        startTime: serverTimestamp(),
                        status: 'active',
                        cheatingFlags: 0
                    });

                    this.sessionId = sessionRef.id;
                    this.userId = userData.name;

                    // 更新 UI 状态
                    this.updateSystemStatus('在线 (Recording)', 'bg-green-500');
                    document.getElementById('registration-modal').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('registration-modal').style.display = 'none';
                    }, 300);

                    // 启动实验流程：请求全屏 -> 开始记录
                    this.enterFullscreen();
                    this.isTracking = true;
                    this.logSystemEvent('SESSION_START');

                } catch (err) {
                    console.error("Init Failed:", err);
                    alert("无法连接到实验服务器，请检查网络后重试。");
                    btn.disabled = false;
                    btn.innerText = "重试";
                }
            }

            /**
             * 核心追踪循环：基于时间差的节流 (Delta-Time Throttling)
             * 确保采样率稳定在 30Hz，不受屏幕刷新率影响
             */
            trackingLoop(timestamp) {
                if (!this.isTracking) {
                    requestAnimationFrame(this.trackingLoop.bind(this));
                    return;
                }

                const deltaTime = timestamp - this.lastFrameTime;

                if (deltaTime >= this.frameInterval) {
                    // 如果有缓存的鼠标位置，则进行处理
                    if (this.lastMouseEvent) {
                        this.processMouseEvent(this.lastMouseEvent);
                    }
                    
                    // 修正时间漂移
                    this.lastFrameTime = timestamp - (deltaTime % this.frameInterval);
                }

                requestAnimationFrame(this.trackingLoop.bind(this));
            }

            cacheMousePosition(e) {
                this.lastMouseEvent = e;
            }

            /**
             * 数据处理流水线：AOI 判定 -> 坐标归一化 -> 缓冲
             */
            processMouseEvent(e) {
                // 1. 高效判定 AOI (利用 CSS 宽度的 7/12 = 58.33%)
                const xRatio = e.clientX / window.innerWidth;
                const aoiType = xRatio <= 0.5833? 'text' : 'question';
                const container = this.aoiElements;

                if (!container) return;

                // 2. 获取容器几何信息 (getBoundingClientRect 是视口相对坐标)
                const rect = container.getBoundingClientRect();

                // 3. 坐标归一化 (0.0000 - 1.0000)
                // 限制边界防止计算出负数或大于1的值
                const nx = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const ny = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));

                // 4. 计算绝对语义位置 (加入 ScrollTop)
                // 这对于长文本阅读分析至关重要
                const absY = container.scrollTop + (e.clientY - rect.top);

                const dataPoint = {
                    t: Date.now(),          // 绝对时间戳用于同步
                    a: aoiType === 'text'? 0 : 1, // 压缩字段：0=阅读区, 1=答题区
                    x: Number(nx.toFixed(4)),      // 保留4位小数 (精度约0.2像素)
                    y: Number(ny.toFixed(4)),
                    s: Math.round(absY)     // 滚动偏移量
                };

                this.mouseBuffer.push(dataPoint);

                // 缓冲区满自动刷新
                if (this.mouseBuffer.length >= this.BUFFER_LIMIT) {
                    this.flushMouseBuffer();
                }
            }

            /**
             * 数据上传：使用 Firestore 子集合与 addDoc
             * 避免单文档 1MB 限制
             */
            async flushMouseBuffer() {
                if (this.mouseBuffer.length === 0 ||!this.sessionId) return;

                const chunk =;
                this.mouseBuffer =; // 立即清空，防止重入

                try {
                    // 写入到 sessions/{id}/traces 子集合
                    const tracesRef = collection(this.db, `sessions/${this.sessionId}/traces`);
                    await addDoc(tracesRef, {
                        d: chunk, // 'd' 代表 data，压缩键名
                        ts: serverTimestamp()
                    });
                } catch (err) {
                    console.warn("Telemetry Sync Error:", err);
                    // 实际生产中应在此处加入 IndexedDB 离线重试逻辑
                }
            }

            /**
             * 反作弊：全屏状态监控
             */
            handleFullscreen() {
                if (!document.fullscreenElement && this.isTracking) {
                    this.logSystemEvent('FULLSCREEN_EXIT');
                    // 触发 UI 阻断
                    document.getElementById('fullscreen-warning').style.display = 'flex';
                }
            }

            /**
             * 反作弊：标签页可见性监控
             */
            handleVisibility() {
                if (document.hidden) {
                    this.logSystemEvent('TAB_HIDDEN');
                } else {
                    this.logSystemEvent('TAB_VISIBLE');
                }
            }

            /**
             * 辅助方法：进入全屏
             */
            enterFullscreen() {
                const el = document.documentElement;
                if (el.requestFullscreen) {
                    el.requestFullscreen().catch(err => {
                        console.warn("Fullscreen blocked:", err);
                        alert("请允许全屏模式以进行考试。");
                    });
                }
            }

            /**
             * 记录关键系统事件
             */
            async logSystemEvent(type, payload = {}) {
                if (!this.sessionId) return;

                const eventData = {
                    type: type,
                    t: Date.now(),
                   ...payload
                };

                // 使用 arrayUnion 将事件追加到主文档
                const sessionDoc = doc(this.db, "sessions", this.sessionId);
                try {
                    await updateDoc(sessionDoc, {
                        events: arrayUnion(eventData)
                    });
                } catch (err) {
                    console.error("Log Error:", err);
                }
            }

            /**
             * 稳健性：页面卸载时的强制刷新
             * 尝试使用 fetch keepalive 保证请求发出
             */
            flushAllData() {
                if (!this.sessionId) return;

                // 刷新剩余轨迹
                if (this.mouseBuffer.length > 0) {
                    this.flushMouseBuffer(); 
                    // 注：Firebase SDK 的网络请求在页面关闭时可能不可靠。
                    // 理想情况下，此处应使用 fetch(cloudFunctionUrl, { keepalive: true, body:... })
                    // 但为保持代码自包含，此处仍调用 SDK 方法。
                }
            }

            updateSystemStatus(text, colorClass) {
                const statusEl = document.getElementById('system-status');
                const dotEl = document.getElementById('system-status-dot');
                statusEl.innerText = text;
                dotEl.className = `w-2 h-2 rounded-full ${colorClass}`;
            }
        }

        // --- 启动系统 ---
        const tracker = new CognitiveTracker();
    </script>
</body>
</html>
