<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CET-6 沉浸式阅读测评系统 (AOI追踪版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 核心布局：禁止整体滚动，采用内部区域独立滚动 */
        body { 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; /* 防止复制，减少作弊并净化鼠标数据 */
        }

        /* 左侧阅读区：允许滚动，模拟纸质阅读体验 */
        #reading-aoi {
            overflow-y: auto;
            border-right: 2px solid #e2e8f0;
            background-color: #f8fafc;
            cursor: text; /* 提示这是文本区 */
        }
        /* 确保左侧阅读区可以独立滚动，这是记录 CET-6 "Scan & Locate" 行为的关键 */
        #reading-pane {
            overflow-y: auto; 
            height: 100%;
            padding-bottom: 50px; /* 防止底部文字被遮挡 */
        }
        /* 右侧答题区：固定布局，防止题目跑出视线 */
        #question-aoi {
            overflow-y: auto;
            background-color: #ffffff;
            cursor: default;
        }

        /* 选中态样式 */
       .option-card {
            transition: all 0.2s;
        }
       .option-card:hover {
            background-color: #f1f5f9;
        }
       .option-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* 状态指示灯 */
       .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
       .status-reading { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
       .status-answering { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
    </style>
</head>
<body class="text-slate-800 font-sans flex flex-col">

    <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 shadow-sm flex-none">
        <div class="flex items-center space-x-4">
            <span class="font-bold text-lg tracking-tight text-slate-700">CET-6 Reading Section</span>
            <div class="flex items-center text-xs px-3 py-1 bg-slate-100 rounded-full border border-slate-200">
                <span id="phase-indicator" class="status-dot status-reading mr-2"></span>
                <span id="phase-text" class="font-mono text-slate-500 font-bold uppercase">Reading Phase</span>
            </div>
        </div>
        <div class="text-sm text-slate-500 font-mono">
            Time Elapsed: <span id="timer">00:00</span>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <section id="reading-aoi" class="w-7/12 p-8 lg:p-12 relative" data-aoi="reading">
            <div class="max-w-3xl mx-auto">
                <h1 id="passage-title" class="text-2xl font-serif font-bold mb-6 text-slate-900 leading-tight">
                    Wait for passage loading...
                </h1>
                <div id="passage-content" class="prose prose-slate prose-lg text-justify leading-loose text-slate-600 font-serif">
                    </div>
            </div>
        </section>

        <section id="question-aoi" class="w-5/12 bg-white flex flex-col border-l border-slate-200 relative" data-aoi="answering">
            <div class="h-1 bg-slate-100 w-full flex-none">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div>
            </div>

            <div class="flex-1 p-8 overflow-y-auto">
                <div class="mb-2">
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">Question <span id="q-index">1</span>/5</span>
                </div>
                
                <div id="question-container" class="space-y-6">
                    <h3 id="q-stem" class="text-lg font-medium text-slate-800">Loading Question...</h3>
                    
                    <div id="options-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white flex justify-between items-center flex-none">
                <button onclick="prevQuestion()" class="text-sm text-slate-400 hover:text-slate-600 font-medium px-4 py-2">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Previous
                </button>
                <button id="btn-next" onclick="nextQuestion()" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-200 transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed">
                    Next Question <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** Firebase 配置 (已自动填入您的配置) ***
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // *** 全局状态管理 ***
        const state = {
            sessionId: "sess_" + Date.now(),
            examData: null,          // 包含文章和题目的完整结构
            currentQIndex: 0,
            
            // 关键：时空分割状态
            currentPhase: 'reading', // 'reading' | 'answering'
            hasEnteredAnswerZone: false, // 是否已经进入过答题区（用于触发首次决策时间）
            
            // 过程数据缓存
            logs: {
                reading_logs:,    // 纯阅读阶段轨迹 (用于分析PAR)
                answering_logs:,  // 答题阶段轨迹 (用于分析犹豫)
                transitions:      // 区域切换事件 (Reading <-> Answering)
            },
            
            startTime: Date.now()
        };

        // *** 1. 初始化逻辑 ***
        async function init() {
            // 模拟加载一篇CET-6真题数据 (实际应从 Firestore 读取)
            // 这里为了演示直接构造数据，真实场景请替换为 await getDoc(...)
            const mockPassage = {
                title: "The Impact of Artificial Intelligence on Future Employment",
                content: `<p>The rapid advancement of artificial intelligence (AI) has sparked intense debate regarding its potential impact on the job market. Proponents argue that AI will create new industries and opportunities, much like the Industrial Revolution did in the 19th century. They point to the growing demand for data scientists, AI ethicists, and machine learning engineers as evidence of this shift.</p>
                          <p>However, critics express concern that AI automation will displace a significant portion of the workforce, particularly in sectors reliant on routine tasks. Manufacturing, transportation, and customer service are cited as industries most at risk. A report by the World Economic Forum predicts that while 85 million jobs may be displaced by 2025, 97 million new roles could emerge.</p>
                          <p>The key challenge lies in the "reskilling" revolution. Workers displaced by automation must be provided with the training and education necessary to transition into these new roles. Governments and corporations face the daunting task of creating infrastructure to support this massive workforce transition.</p>
                          <p>Ultimately, the net impact of AI on employment will depend not just on the technology itself, but on the policies and educational systems put in place to manage its integration into society.</p>`,
                questions:,
                        correct: 1
                    },
                    {
                        id: "q2",
                        stem: "Which sectors are mentioned as being most at risk of displacement?",
                        options:,
                        correct: 2
                    }
                ]
            };

            state.examData = mockPassage;
            renderInterface();
            startTracking();
            startTimer();
        }

        function renderInterface() {
            // 渲染文章
            document.getElementById('passage-title').innerText = state.examData.title;
            document.getElementById('passage-content').innerHTML = state.examData.content;
            renderQuestion();
        }

        function renderQuestion() {
            const q = state.examData.questions[state.currentQIndex];
            
            // 更新进度
            document.getElementById('q-index').innerText = state.currentQIndex + 1;
            document.getElementById('progress-bar').style.width = `${((state.currentQIndex + 1) / state.examData.questions.length) * 100}%`;
            
            // 渲染题干
            document.getElementById('q-stem').innerText = q.stem;
            
            // 渲染选项
            const list = document.getElementById('options-list');
            list.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = "option-card border border-slate-200 rounded-lg p-4 cursor-pointer flex items-start gap-3 hover:border-blue-400 group";
                div.onclick = () => selectOption(div, idx);
                
                div.innerHTML = `
                    <div class="w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-400 group-hover:border-blue-400 group-hover:text-blue-500 transition-colors bg-white mt-0.5">
                        ${String.fromCharCode(65 + idx)}
                    </div>
                    <div class="text-sm text-slate-700 leading-relaxed">${opt}</div>
                `;
                list.appendChild(div);
            });

            // 重置状态
            document.getElementById('btn-next').disabled = true;
            
            // 重置本题的阶段标记 (新的一题，重新开始算阅读)
            state.hasEnteredAnswerZone = false;
            updatePhaseDisplay('reading');
        }

        window.selectOption = (el, idx) => {
            // UI 更新
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('btn-next').disabled = false;
            
            // 记录选择事件
            logAction('select_option', { index: idx });
        };

        window.nextQuestion = async () => {
            // 提交本题数据 (上传到 Firestore)
            await flushLogs();

            if (state.currentQIndex < state.examData.questions.length - 1) {
                state.currentQIndex++;
                renderQuestion();
            } else {
                alert("Exam Finished!");
            }
        };

        // *** 2. 核心：智能AOI追踪系统 ***
        function startTracking() {
            const readingZone = document.getElementById('reading-aoi');
            const questionZone = document.getElementById('question-aoi');
            
            // 节流，每50ms记录一次 (20Hz)，避免数据量过大
            let lastTime = 0;
            
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                
                // 1. 判定当前区域
                let currentZone = 'neutral';
                if (readingZone.contains(e.target)) currentZone = 'reading';
                if (questionZone.contains(e.target)) currentZone = 'answering';

                // 2. 状态机：检测阶段切换
                if (currentZone === 'answering' &&!state.hasEnteredAnswerZone) {
                    // 首次进入答题区：标记为犹豫/决策分析的真正起点
                    state.hasEnteredAnswerZone = true;
                    state.currentPhase = 'answering';
                    updatePhaseDisplay('answering');
                    
                    // 记录这一关键时刻
                    logAction('phase_switch', { from: 'reading', to: 'answering' });
                } else if (currentZone === 'reading' && state.hasEnteredAnswerZone) {
                    // 如果已经开始答题却又回到阅读区 -> 这是“回视”(Regression)
                    // 我们不把阶段切回 reading，而是记录一次 look-back 事件
                    // 这样不会打断 hesitation 的计算流
                }

                // 3. 记录轨迹数据
                if (now - lastTime > 50) {
                    const point = {
                        t: now - state.startTime,
                        x: Math.round(e.clientX),
                        y: Math.round(e.clientY),
                        // 记录滚动位置，这对于分析“读到哪一行”至关重要
                        scroll: currentZone === 'reading'? readingZone.scrollTop : questionZone.scrollTop
                    };

                    // 分流存储：解决您提出的“污染”问题
                    if (state.currentPhase === 'reading') {
                        state.logs.reading_logs.push(point); // 这些是“伴读”数据
                    } else {
                        state.logs.answering_logs.push(point); // 这些是“犹豫”数据
                    }
                    
                    lastTime = now;
                }
            });

            // 监听滚动事件 (滚动也是重要的阅读行为)
            readingZone.addEventListener('scroll', () => {
                if (state.currentPhase === 'reading') {
                    logAction('scroll', { top: readingZone.scrollTop, zone: 'reading' });
                }
            });
        }

        // *** 辅助功能 ***
        function updatePhaseDisplay(phase) {
            const dot = document.getElementById('phase-indicator');
            const text = document.getElementById('phase-text');
            
            if (phase === 'reading') {
                dot.className = "status-dot status-reading mr-2";
                text.innerText = "Reading Phase (Tracking Eye-Mouse)";
                text.className = "font-mono text-emerald-600 font-bold uppercase text-xs";
            } else {
                dot.className = "status-dot status-answering mr-2";
                text.innerText = "Decision Phase (Tracking Hesitation)";
                text.className = "font-mono text-amber-600 font-bold uppercase text-xs";
            }
        }

        function logAction(type, data) {
            state.logs.transitions.push({
                type: type,
                t: Date.now() - state.startTime,
               ...data
            });
        }

        async function flushLogs() {
            // 这里将数据打包上传 Firestore
            const packet = {
                q_id: state.examData.questions[state.currentQIndex].id,
                session_id: state.sessionId,
                // 分离上传，后端分析时极其方便
                reading_trace: state.logs.reading_logs,
                decision_trace: state.logs.answering_logs, 
                events: state.logs.transitions,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "process_logs"), packet);
                console.log("Logs uploaded:", packet);
                // 清空缓存
                state.logs.reading_logs =;
                state.logs.answering_logs =;
                state.logs.transitions =;
            } catch (e) {
                console.error("Upload failed", e);
            }
        }

        function startTimer() {
            setInterval(() => {
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        // 启动
        init();

    </script>
</body>
</html>

