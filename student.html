<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CET-6 沉浸式阅读测评系统 (AOI追踪版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 核心布局：禁止整体滚动，采用内部区域独立滚动 */
        body { 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; /* 防止复制，减少作弊并净化鼠标数据 */
        }

        /* 左侧阅读区：允许滚动，模拟纸质阅读体验 */
        #reading-aoi {
            overflow-y: auto;
            border-right: 2px solid #e2e8f0;
            background-color: #f8fafc;
            cursor: text; /* 提示这是文本区 */
        }
        /* 确保左侧阅读区可以独立滚动，这是记录 CET-6 "Scan & Locate" 行为的关键 */
        #reading-pane {
            overflow-y: auto; 
            height: 100%;
            padding-bottom: 50px; /* 防止底部文字被遮挡 */
        }
        /* 右侧答题区：固定布局，防止题目跑出视线 */
        #question-aoi {
            overflow-y: auto;
            background-color: #ffffff;
            cursor: default;
        }

        /* 选中态样式 */
       .option-card {
            transition: all 0.2s;
        }
       .option-card:hover {
            background-color: #f1f5f9;
        }
       .option-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* 状态指示灯 */
       .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
       .status-reading { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
       .status-answering { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
    </style>
</head>
<body class="text-slate-800 font-sans flex flex-col">

    <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 shadow-sm flex-none">
        <div class="flex items-center space-x-4">
            <span class="font-bold text-lg tracking-tight text-slate-700">CET-6 Reading Section</span>
            <div class="flex items-center text-xs px-3 py-1 bg-slate-100 rounded-full border border-slate-200">
                <span id="phase-indicator" class="status-dot status-reading mr-2"></span>
                <span id="phase-text" class="font-mono text-slate-500 font-bold uppercase">Reading Phase</span>
            </div>
        </div>
        <div class="text-sm text-slate-500 font-mono">
            Time Elapsed: <span id="timer">00:00</span>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <section id="reading-aoi" class="w-7/12 p-8 lg:p-12 relative" data-aoi="reading">
            <div class="max-w-3xl mx-auto">
                <h1 id="passage-title" class="text-2xl font-serif font-bold mb-6 text-slate-900 leading-tight">
                    <i class="fa-solid fa-circle-notch fa-spin text-blue-500 mr-2"></i>Loading Passage...
                </h1>
                <div id="passage-content" class="prose prose-slate prose-lg text-justify leading-loose text-slate-600 font-serif">
                </div>
            </div>
        </section>

        <section id="question-aoi" class="w-5/12 bg-white flex flex-col border-l border-slate-200 relative" data-aoi="answering">
            <div class="h-1 bg-slate-100 w-full flex-none">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div>
            </div>

            <div class="flex-1 p-8 overflow-y-auto">
                <div class="mb-2">
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">Question <span id="q-index">1</span>/<span id="q-total">--</span></span>
                </div>
                
                <div id="question-container" class="space-y-6">
                    <h3 id="q-stem" class="text-lg font-medium text-slate-800">Preparing Exam Data...</h3>
                    
                    <div id="options-list" class="space-y-3">
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white flex justify-between items-center flex-none">
                <button onclick="prevQuestion()" class="text-sm text-slate-400 hover:text-slate-600 font-medium px-4 py-2 opacity-50 cursor-not-allowed">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Previous
                </button>
                <button id="btn-next" onclick="nextQuestion()" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-200 transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed">
                    Next Question <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** Firebase 配置 ***
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { console.error(e); }
        }
        // 如果环境变量未定义，回退到硬编码配置
        if (!firebaseConfig) {
             firebaseConfig = {
                apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
                authDomain: "hesitation-research.firebaseapp.com",
                projectId: "hesitation-research",
                storageBucket: "hesitation-research.firebasestorage.app",
                messagingSenderId: "633469376688",
                appId: "1:633469376688:web:dc26878c070a05a35b4375"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // *** 全局状态管理 ***
        const state = {
            sessionId: "sess_" + Date.now(),
            examData: null,          // 将包含 { title, content, questions: [] }
            currentQIndex: 0,
            
            // 关键：时空分割状态
            currentPhase: 'reading', // 'reading' | 'answering'
            hasEnteredAnswerZone: false, // 是否已经进入过答题区
            
            // 过程数据缓存
            logs: {
                reading_logs: [],    // 纯阅读阶段轨迹
                answering_logs: [],  // 答题阶段轨迹
                transitions: []      // 区域切换事件
            },
            
            startTime: Date.now()
        };

        // *** Helper: 获取数据路径 ***
        // 与 admin.html 保持一致的路径结构
        function getCollectionRef(name) {
            return collection(db, 'artifacts', appId, 'public', 'data', name);
        }

        // *** 1. 初始化逻辑 (改为从 Firebase 拉取) ***
        async function init() {
            try {
                // 1. 匿名登录 (确保有权限读取数据)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. 拉取最新的一篇文章
                console.log("Fetching passage...");
                const passageQuery = query(
                    getCollectionRef("reading_materials"), 
                    orderBy("created_at", "desc"), 
                    limit(1)
                );
                
                const passageSnapshot = await getDocs(passageQuery);
                
                if (passageSnapshot.empty) {
                    document.getElementById('passage-title').innerText = "暂无考试数据";
                    document.getElementById('passage-content').innerText = "请先在管理后台录入文章和题目。";
                    document.getElementById('q-stem').innerText = "No questions available.";
                    return;
                }

                const passageDoc = passageSnapshot.docs[0];
                const passageData = passageDoc.data();
                const passageId = passageDoc.id;

                // 3. 拉取该文章对应的题目
                console.log("Fetching questions for passage:", passageId);
                const questionsQuery = query(
                    getCollectionRef("questions"),
                    where("passage_id", "==", passageId)
                );
                
                const questionsSnapshot = await getDocs(questionsQuery);
                let questions = [];
                questionsSnapshot.forEach(doc => {
                    questions.push({ id: doc.id, ...doc.data() });
                });

                // 简单的客户端排序 (如果题目有顺序字段最好，这里暂按创建时间或默认顺序)
                questions.sort((a, b) => (a.created_at?.seconds || 0) - (b.created_at?.seconds || 0));

                if (questions.length === 0) {
                    alert("该文章下暂无题目，请联系管理员。");
                }

                // 4. 组装数据
                state.examData = {
                    id: passageId,
                    title: passageData.title,
                    content: passageData.content_html,
                    questions: questions
                };

                // 5. 渲染界面
                renderInterface();
                startTracking();
                startTimer();

            } catch (error) {
                console.error("Initialization failed:", error);
                document.getElementById('passage-title').innerText = "加载失败";
                document.getElementById('passage-content').innerText = "无法连接到数据库，请刷新重试。\n" + error.message;
            }
        }

        function renderInterface() {
            // 渲染文章
            document.getElementById('passage-title').innerText = state.examData.title;
            document.getElementById('passage-content').innerHTML = state.examData.content;
            
            // 更新总题数显示
            document.getElementById('q-total').innerText = state.examData.questions.length;
            
            renderQuestion();
        }

        function renderQuestion() {
            const q = state.examData.questions[state.currentQIndex];
            if (!q) return;

            // 更新进度
            document.getElementById('q-index').innerText = state.currentQIndex + 1;
            const progress = ((state.currentQIndex + 1) / state.examData.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // 渲染题干
            document.getElementById('q-stem').innerText = q.stem;
            
            // 渲染选项
            const list = document.getElementById('options-list');
            list.innerHTML = '';
            
            // 确保 options 存在且是数组
            if (Array.isArray(q.options)) {
                q.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = "option-card border border-slate-200 rounded-lg p-4 cursor-pointer flex items-start gap-3 hover:border-blue-400 group";
                    div.onclick = () => selectOption(div, idx);
                    
                    div.innerHTML = `
                        <div class="w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-400 group-hover:border-blue-400 group-hover:text-blue-500 transition-colors bg-white mt-0.5">
                            ${String.fromCharCode(65 + idx)}
                        </div>
                        <div class="text-sm text-slate-700 leading-relaxed">${opt}</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<div class="text-red-500">选项数据格式错误</div>';
            }

            // 重置状态
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-next').innerHTML = 
                state.currentQIndex === state.examData.questions.length - 1 
                ? 'Submit Exam <i class="fa-solid fa-check ml-2"></i>' 
                : 'Next Question <i class="fa-solid fa-arrow-right ml-2"></i>';
            
            // 重置本题的阶段标记 (新的一题，重新开始算阅读)
            state.hasEnteredAnswerZone = false;
            updatePhaseDisplay('reading');
        }

        window.selectOption = (el, idx) => {
            // UI 更新
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('btn-next').disabled = false;
            
            // 记录选择事件
            logAction('select_option', { index: idx, q_id: state.examData.questions[state.currentQIndex].id });
        };

        window.nextQuestion = async () => {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';

            // 提交本题数据 (上传到 Firestore)
            await flushLogs();

            if (state.currentQIndex < state.examData.questions.length - 1) {
                state.currentQIndex++;
                renderQuestion();
            } else {
                // 考试结束逻辑：提交最终数据并跳转或显示感谢
                await submitFinalExamData();
                alert("Exam Finished! Thank you for your participation.");
                // 可选：跳转回首页
                // window.location.href = 'index.html'; 
            }
        };
        
        // 提交最终汇总数据 (可选，这里仅作占位，目前 flushLogs 已经保存了每一题的过程)
        async function submitFinalExamData() {
             // 可以在这里创建一个 exam_submission 记录，汇总分数等
             const submissionRef = getCollectionRef("exam_submissions");
             await addDoc(submissionRef, {
                 session_id: state.sessionId,
                 user_id: auth.currentUser ? auth.currentUser.uid : 'anonymous',
                 passage_id: state.examData.id,
                 submitted_at: serverTimestamp(),
                 duration_seconds: Math.floor((Date.now() - state.startTime) / 1000),
                 // 可以添加更多汇总信息
                 total_questions: state.examData.questions.length
             });
        }

        // *** 2. 核心：智能AOI追踪系统 ***
        function startTracking() {
            const readingZone = document.getElementById('reading-aoi');
            const questionZone = document.getElementById('question-aoi');
            
            // 节流，每50ms记录一次 (20Hz)，避免数据量过大
            let lastTime = 0;
            
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                
                // 1. 判定当前区域
                let currentZone = 'neutral';
                if (readingZone.contains(e.target)) currentZone = 'reading';
                if (questionZone.contains(e.target)) currentZone = 'answering';

                // 2. 状态机：检测阶段切换
                if (currentZone === 'answering' && !state.hasEnteredAnswerZone) {
                    // 首次进入答题区：标记为犹豫/决策分析的真正起点
                    state.hasEnteredAnswerZone = true;
                    state.currentPhase = 'answering';
                    updatePhaseDisplay('answering');
                    
                    // 记录这一关键时刻
                    logAction('phase_switch', { from: 'reading', to: 'answering' });
                } else if (currentZone === 'reading' && state.hasEnteredAnswerZone) {
                    // 如果已经开始答题却又回到阅读区 -> 这是“回视”(Regression)
                    // 我们不把阶段切回 reading，而是记录一次 look-back 事件
                }

                // 3. 记录轨迹数据
                if (now - lastTime > 50) {
                    const point = {
                        t: now - state.startTime,
                        x: Math.round(e.clientX),
                        y: Math.round(e.clientY),
                        // 记录滚动位置，这对于分析“读到哪一行”至关重要
                        scroll: currentZone === 'reading' ? readingZone.scrollTop : questionZone.scrollTop
                    };

                    // 分流存储
                    if (state.currentPhase === 'reading') {
                        state.logs.reading_logs.push(point); 
                    } else {
                        state.logs.answering_logs.push(point); 
                    }
                    
                    lastTime = now;
                }
            });

            // 监听滚动事件 (滚动也是重要的阅读行为)
            readingZone.addEventListener('scroll', () => {
                if (state.currentPhase === 'reading') {
                    logAction('scroll', { top: readingZone.scrollTop, zone: 'reading' });
                }
            });
        }

        // *** 辅助功能 ***
        function updatePhaseDisplay(phase) {
            const dot = document.getElementById('phase-indicator');
            const text = document.getElementById('phase-text');
            
            if (phase === 'reading') {
                dot.className = "status-dot status-reading mr-2";
                text.innerText = "Reading Phase (Tracking Eye-Mouse)";
                text.className = "font-mono text-emerald-600 font-bold uppercase text-xs";
            } else {
                dot.className = "status-dot status-answering mr-2";
                text.innerText = "Decision Phase (Tracking Hesitation)";
                text.className = "font-mono text-amber-600 font-bold uppercase text-xs";
            }
        }

        function logAction(type, data) {
            state.logs.transitions.push({
                type: type,
                t: Date.now() - state.startTime,
                ...data
            });
        }

        async function flushLogs() {
            if (!state.examData || !state.examData.questions[state.currentQIndex]) return;

            // 这里将数据打包上传 Firestore
            const packet = {
                q_id: state.examData.questions[state.currentQIndex].id,
                session_id: state.sessionId,
                user_id: auth.currentUser ? auth.currentUser.uid : 'anonymous',
                passage_id: state.examData.id,
                // 分离上传，后端分析时极其方便
                reading_trace: state.logs.reading_logs,
                decision_trace: state.logs.answering_logs, 
                events: state.logs.transitions,
                timestamp: serverTimestamp()
            };

            try {
                // 保存到 process_logs 集合
                await addDoc(getCollectionRef("process_logs"), packet);
                console.log("Logs uploaded:", packet);
                
                // 清空缓存
                state.logs.reading_logs = [];
                state.logs.answering_logs = [];
                state.logs.transitions = [];
            } catch (e) {
                console.error("Upload failed", e);
            }
        }

        function startTimer() {
            setInterval(() => {
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        // 启动
        init();

    </script>
</body>
</html>
