<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>在线测评系统 - 学生端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 动画效果 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-pop-up { animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* 自定义样式 */
        .option-card { transition: all 0.2s; }
        .option-card:hover { background-color: #f8fafc; border-color: #94a3b8; }
        .option-card.selected { background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
        .confidence-btn { transition: transform 0.1s, box-shadow 0.1s; }
        .confidence-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- 1. 顶部导航栏 -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-700">在线测评</h1>
            </div>
            <div id="user-info-display" class="hidden text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full"></div>
        </div>
    </nav>

    <!-- 2. 主内容区域 -->
    <main class="flex-1 w-full max-w-2xl mx-auto p-4 md:p-6 flex flex-col justify-center">

        <!-- 阶段 A: 登录界面 -->
        <div id="login-view" class="w-full max-w-md mx-auto animate-fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 text-center">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i class="fa-solid fa-user-check"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">考生登录</h2>
                    <p class="text-slate-500 mt-2 text-sm">请输入您的信息开始答题，系统将自动记录您的答题过程数据用于研究。</p>
                </div>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">姓名</label>
                        <input type="text" id="input-name" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-blue-500 outline-none transition-all" placeholder="请输入您的真实姓名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">学号 / ID</label>
                        <input type="text" id="input-id" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-blue-500 outline-none transition-all" placeholder="请输入学号">
                    </div>
                    <button onclick="startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md shadow-blue-200 mt-2">
                        开始答题 <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 阶段 B: 答题界面 -->
        <div id="quiz-view" class="hidden w-full animate-fade-in">
            <div class="mb-6">
                <div class="flex justify-between text-xs text-slate-500 mb-2">
                    <span id="progress-text">题目 1 / --</span>
                    <span>进度</span>
                </div>
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-blue-600 rounded-full transition-all duration-500 w-0"></div>
                </div>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-slate-100 relative min-h-[400px] flex flex-col">
                <div id="loading-spinner" class="absolute inset-0 bg-white flex items-center justify-center z-20 hidden">
                    <div class="w-8 h-8 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
                </div>
                <div class="flex-1">
                    <span class="inline-block px-3 py-1 bg-blue-50 text-blue-700 text-xs font-bold rounded-full mb-4">单选题</span>
                    <h3 id="question-text" class="text-xl font-medium text-slate-800 leading-relaxed mb-6"></h3>
                    <div id="options-container" class="space-y-3"></div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                    <button id="submit-btn" onclick="preSubmitCheck()" disabled class="px-8 py-3 bg-slate-200 text-slate-400 font-bold rounded-xl cursor-not-allowed transition-all">
                        提交本题
                    </button>
                </div>
            </div>
        </div>

        <!-- 阶段 C: 提交成功 -->
        <div id="success-view" class="hidden w-full max-w-md mx-auto text-center animate-fade-in">
            <div class="bg-white p-10 rounded-2xl shadow-xl border border-slate-100">
                <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">答题完成</h2>
                <p class="text-slate-500 mb-6">所有数据已成功上传。感谢您的配合！</p>
                <div class="bg-slate-50 p-4 rounded-xl text-left text-sm text-slate-600 mb-6">
                    <p><i class="fa-regular fa-clock mr-2"></i>总用时: <span id="total-time-display" class="font-bold">--</span></p>
                    <p class="mt-2"><i class="fa-solid fa-list-check mr-2"></i>完成题目: <span id="total-count-display" class="font-bold">--</span></p>
                </div>
                <button onclick="location.reload()" class="text-blue-600 hover:text-blue-700 font-medium">返回首页</button>
            </div>
        </div>
    </main>

    <!-- 3. 信心监测弹窗 -->
    <div id="confidence-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8 animate-pop-up">
            <h3 class="text-xl font-bold text-slate-800 text-center mb-2">本次作答自我监测</h3>
            <p class="text-slate-500 text-center text-sm mb-8">请诚实评估：你对刚才所选答案的把握有多大？</p>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="handleConfidence(5)" class="confidence-btn group flex items-center p-4 rounded-xl border border-slate-200 hover:border-emerald-500 hover:bg-emerald-50 bg-white">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg font-bold mr-4">5</div>
                    <div class="text-left"><div class="font-bold text-slate-800">非常有把握</div></div>
                </button>
                <button onclick="handleConfidence(4)" class="confidence-btn group flex items-center p-4 rounded-xl border border-slate-200 hover:border-teal-500 hover:bg-teal-50 bg-white">
                    <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-lg font-bold mr-4">4</div>
                    <div class="text-left"><div class="font-bold text-slate-800">比较有把握</div></div>
                </button>
                <button onclick="handleConfidence(3)" class="confidence-btn group flex items-center p-4 rounded-xl border border-slate-200 hover:border-yellow-500 hover:bg-yellow-50 bg-white">
                    <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg font-bold mr-4">3</div>
                    <div class="text-left"><div class="font-bold text-slate-800">一般 / 不确定</div></div>
                </button>
                <button onclick="handleConfidence(2)" class="confidence-btn group flex items-center p-4 rounded-xl border border-slate-200 hover:border-orange-500 hover:bg-orange-50 bg-white">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg font-bold mr-4">2</div>
                    <div class="text-left"><div class="font-bold text-slate-800">不太有把握</div></div>
                </button>
                <button onclick="handleConfidence(1)" class="confidence-btn group flex items-center p-4 rounded-xl border border-slate-200 hover:border-red-500 hover:bg-red-50 bg-white">
                    <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-lg font-bold mr-4">1</div>
                    <div class="text-left"><div class="font-bold text-slate-800">完全没把握</div></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375",
            measurementId: "G-ZNZ14Q5R98"
        };
        
        const PROJECT_ID = "hesitation-research";

        const state = {
            db: null,
            user: null,
            studentInfo: { name: '', id: '' },
            questions: [],
            currentQIndex: 0,
            answersLog: [], 
            currentMetrics: {
                startTime: 0, firstClickTime: null, changeCount: 0, selectedOption: null, optionId: null
            }
        };

        async function initApp() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            state.db = getFirestore(app);
            try {
                const userCred = await signInAnonymously(auth);
                state.user = userCred.user;
                console.log("System Ready. User:", state.user.uid);
            } catch (error) {
                console.error("Auth Error", error);
                alert("系统连接失败，请刷新重试");
            }
        }

        window.startExam = async function() {
            const name = document.getElementById('input-name').value.trim();
            const id = document.getElementById('input-id').value.trim();
            if (!name || !id) { alert("请填写完整的姓名和学号"); return; }
            state.studentInfo = { name, id };
            document.getElementById('user-info-display').innerText = `${name} (${id})`;
            document.getElementById('user-info-display').classList.remove('hidden');
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden'); 
            document.getElementById('quiz-view').classList.remove('hidden');
            await loadQuestions();
        };

        async function loadQuestions() {
            if (!state.db) return;
            try {
                const qRef = collection(state.db, 'artifacts', PROJECT_ID, 'public', 'data', 'question_bank');
                const qQuery = query(qRef, orderBy('timestamp', 'desc')); 
                const snapshot = await getDocs(qQuery);
                state.questions = [];
                snapshot.forEach(doc => { state.questions.push({ id: doc.id, ...doc.data() }); });
                if (state.questions.length === 0) {
                    alert("题库暂无题目，请联系管理员");
                    location.reload();
                    return;
                }
                renderQuestion();
            } catch (e) {
                console.error("Load Questions Error", e);
                alert("加载题目失败");
            }
        }

        function renderQuestion() {
            const q = state.questions[state.currentQIndex];
            const total = state.questions.length;
            document.getElementById('progress-bar').style.width = `${((state.currentQIndex) / total) * 100}%`;
            document.getElementById('progress-text').innerText = `题目 ${state.currentQIndex + 1} / ${total}`;
            document.getElementById('question-text').innerText = q.text;
            document.getElementById('loading-spinner').classList.add('hidden');
            
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            const options = q.options || []; 
            options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = `option-card w-full p-4 border border-slate-200 rounded-xl cursor-pointer flex items-center gap-3`;
                btn.onclick = () => handleOptionSelect(idx, opt);
                btn.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center shrink-0 dot-indicator"><div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div></div>
                    <span class="text-slate-700 font-medium">${opt}</span>
                `;
                optsContainer.appendChild(btn);
            });
            state.currentMetrics = { startTime: Date.now(), firstClickTime: null, changeCount: 0, selectedOption: null, optionIndex: null };
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.className = "px-8 py-3 bg-slate-200 text-slate-400 font-bold rounded-xl cursor-not-allowed transition-all";
        }

        window.handleOptionSelect = function(idx, text) {
            const now = Date.now();
            if (state.currentMetrics.firstClickTime === null) {
                state.currentMetrics.firstClickTime = now - state.currentMetrics.startTime;
            } else {
                if (state.currentMetrics.optionIndex !== idx) state.currentMetrics.changeCount++;
            }
            state.currentMetrics.selectedOption = text;
            state.currentMetrics.optionIndex = idx;
            const container = document.getElementById('options-container');
            Array.from(container.children).forEach((child, i) => {
                const dot = child.querySelector('.dot-indicator div');
                if (i === idx) {
                    child.classList.add('selected'); child.classList.remove('border-slate-200'); dot.classList.remove('hidden'); child.querySelector('.dot-indicator').classList.add('border-blue-600');
                } else {
                    child.classList.remove('selected'); child.classList.add('border-slate-200'); dot.classList.add('hidden'); child.querySelector('.dot-indicator').classList.remove('border-blue-600');
                }
            });
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = false;
            submitBtn.className = "px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-95";
        };

        window.preSubmitCheck = function() {
            if (state.currentMetrics.optionIndex === null) return;
            document.getElementById('confidence-modal').classList.remove('hidden');
        };

        window.handleConfidence = function(level) {
            const now = Date.now();
            const q = state.questions[state.currentQIndex];
            state.answersLog.push({
                questionId: q.id,
                questionText: q.text,
                userAnswer: state.currentMetrics.selectedOption,
                behaviorMetrics: {
                    totalDuration: now - state.currentMetrics.startTime,
                    timeToFirstClick: state.currentMetrics.firstClickTime,
                    answerChangeCount: state.currentMetrics.changeCount,
                    timestamp: now
                },
                metacognition: { confidenceLevel: level }
            });
            document.getElementById('confidence-modal').classList.add('hidden');
            if (state.currentQIndex < state.questions.length - 1) {
                state.currentQIndex++;
                renderQuestion();
            } else {
                finishExam();
            }
        };

        async function finishExam() {
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            const sessionData = {
                student: state.studentInfo,
                userId: state.user.uid,
                startTime: state.answersLog[0]?.behaviorMetrics.timestamp - state.answersLog[0]?.behaviorMetrics.totalDuration,
                endTime: Date.now(),
                answers: state.answersLog,
                summary: {
                    totalQuestions: state.questions.length,
                    avgConfidence: state.answersLog.reduce((acc, cur) => acc + cur.metacognition.confidenceLevel, 0) / state.questions.length
                },
                submittedAt: serverTimestamp()
            };
            try {
                await setDoc(doc(collection(state.db, 'artifacts', PROJECT_ID, 'public', 'data', 'exam_results')), sessionData);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                const durationMs = sessionData.endTime - sessionData.startTime;
                document.getElementById('total-time-display').innerText = `${Math.floor(durationMs / 60000)}分 ${Math.floor((durationMs % 60000) / 1000)}秒`;
                document.getElementById('total-count-display').innerText = `${state.questions.length} 题`;
            } catch (e) {
                console.error("Upload Error", e);
                alert("数据上传失败");
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }
        initApp();
    </script>
</body>
</html>
