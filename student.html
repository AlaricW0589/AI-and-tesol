<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CET-6 沉浸式阅读测评系统 (AOI追踪版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 核心布局：禁止整体滚动，采用内部区域独立滚动 */
        body { 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; /* 防止复制，减少作弊并净化鼠标数据 */
        }

        /* 左侧阅读区：允许滚动，模拟纸质阅读体验 */
        #reading-aoi {
            overflow-y: auto;
            border-right: 2px solid #e2e8f0;
            background-color: #f8fafc;
            cursor: text; /* 提示这是文本区 */
        }
        /* 确保左侧阅读区可以独立滚动，这是记录 CET-6 "Scan & Locate" 行为的关键 */
        #reading-pane {
            overflow-y: auto; 
            height: 100%;
            padding-bottom: 50px; /* 防止底部文字被遮挡 */
        }
        /* 右侧答题区：固定布局，防止题目跑出视线 */
        #question-aoi {
            overflow-y: auto;
            background-color: #ffffff;
            cursor: default;
        }

        /* 选中态样式 */
       .option-card {
            transition: all 0.2s;
        }
       .option-card:hover {
            background-color: #f1f5f9;
        }
       .option-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* 状态指示灯 */
       .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
       .status-reading { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
       .status-answering { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }

       /* 注册弹窗样式 */
       .modal-overlay {
           position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100;
           display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
       }
    </style>
</head>
<body class="text-slate-800 font-sans flex flex-col">

    <!-- 1. 学生信息注册弹窗 (新增) -->
    <div id="registration-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] max-w-full overflow-hidden animate-fade-in">
            <div class="bg-slate-800 p-6 text-white">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fa-solid fa-user-graduate mr-3"></i> 
                    Participant Registration
                </h2>
                <p class="text-slate-400 text-xs mt-1">请输入您的信息以开始实验 (Please fill in your details)</p>
            </div>
            
            <form id="reg-form" class="p-8 space-y-5">
                <!-- 基本信息 -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name (Pinyin/English)</label>
                        <input type="text" id="reg-name" required placeholder="e.g., WangJie" 
                            class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" pattern="[a-zA-Z\s]+">
                        <p class="text-[10px] text-slate-400 mt-1">* 请使用拼音或英文，不含特殊字符</p>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Gender</label>
                        <select id="reg-gender" required class="w-full p-2 border border-slate-300 rounded bg-white">
                            <option value="" disabled selected>Select...</option>
                            <option value="M">Male (男)</option>
                            <option value="F">Female (女)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Age</label>
                        <input type="number" id="reg-age" required min="10" max="99" class="w-full p-2 border border-slate-300 rounded">
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Grade / Year</label>
                        <input type="text" id="reg-grade" required placeholder="e.g., Undergraduate Year 3" class="w-full p-2 border border-slate-300 rounded">
                    </div>
                </div>

                <!-- 协议与状态确认 -->
                <div class="bg-slate-50 p-4 rounded border border-slate-100 space-y-3">
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" id="check-alert" required class="mt-1 mr-3">
                        <span class="text-xs text-slate-600">
                            <strong>状态确认 (State Check):</strong> 我当前处于清醒状态，未受酒精、药物或极度疲劳影响，能够集中注意力完成测试。
                        </span>
                    </label>
                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" id="check-privacy" required class="mt-1 mr-3">
                        <span class="text-xs text-slate-600">
                            <strong>隐私协议 (Privacy):</strong> 我同意本实验收集我的作答数据及操作行为（鼠标轨迹等）用于科学研究。数据将严格保密并匿名处理。
                        </span>
                    </label>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 flex items-center justify-center">
                    <span>Generate ID & Start Exam</span>
                    <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- 主界面 Header -->
    <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 shadow-sm flex-none">
        <div class="flex items-center space-x-4">
            <span class="font-bold text-lg tracking-tight text-slate-700">CET-6 Reading Section</span>
            <div class="flex items-center text-xs px-3 py-1 bg-slate-100 rounded-full border border-slate-200">
                <span id="phase-indicator" class="status-dot status-reading mr-2"></span>
                <span id="phase-text" class="font-mono text-slate-500 font-bold uppercase">Reading Phase</span>
            </div>
        </div>
        <div class="flex items-center space-x-6 text-sm font-mono text-slate-500">
            <div>Student ID: <span id="display-student-id" class="font-bold text-slate-800">--</span></div>
            <div>Time: <span id="timer">00:00</span></div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <section id="reading-aoi" class="w-7/12 p-8 lg:p-12 relative" data-aoi="reading">
            <div class="max-w-3xl mx-auto">
                <h1 id="passage-title" class="text-2xl font-serif font-bold mb-6 text-slate-900 leading-tight">
                    <i class="fa-solid fa-circle-notch fa-spin text-blue-500 mr-2"></i>Loading Passage...
                </h1>
                <div id="passage-content" class="prose prose-slate prose-lg text-justify leading-loose text-slate-600 font-serif">
                </div>
            </div>
        </section>

        <section id="question-aoi" class="w-5/12 bg-white flex flex-col border-l border-slate-200 relative" data-aoi="answering">
            <div class="h-1 bg-slate-100 w-full flex-none">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-500" style="width: 0%"></div>
            </div>

            <div class="flex-1 p-8 overflow-y-auto">
                <div class="mb-2">
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">Question <span id="q-index">1</span>/<span id="q-total">--</span></span>
                </div>
                
                <div id="question-container" class="space-y-6">
                    <h3 id="q-stem" class="text-lg font-medium text-slate-800">Preparing Exam Data...</h3>
                    
                    <div id="options-list" class="space-y-3">
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white flex justify-between items-center flex-none">
                <button onclick="prevQuestion()" class="text-sm text-slate-400 hover:text-slate-600 font-medium px-4 py-2 opacity-50 cursor-not-allowed">
                    <i class="fa-solid fa-arrow-left mr-1"></i> Previous
                </button>
                <button id="btn-next" onclick="nextQuestion()" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md shadow-blue-200 transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed">
                    Next Question <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *** Firebase 配置 ***
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { console.error(e); }
        }
        if (!firebaseConfig) {
             firebaseConfig = {
                apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
                authDomain: "hesitation-research.firebaseapp.com",
                projectId: "hesitation-research",
                storageBucket: "hesitation-research.firebasestorage.app",
                messagingSenderId: "633469376688",
                appId: "1:633469376688:web:dc26878c070a05a35b4375"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // *** 全局状态管理 ***
        const state = {
            sessionId: "sess_" + Date.now(),
            studentId: null,         // 存放生成的学生ID (e.g., WangJie_M_21_1203)
            studentMeta: {},         // 存放原始学生信息 (Grade, etc.)
            
            examData: null,          
            currentQIndex: 0,
            
            currentPhase: 'reading', 
            hasEnteredAnswerZone: false, 
            
            logs: {
                reading_logs: [],    
                answering_logs: [],  
                transitions: []      
            },
            
            startTime: null,        // 只有在点击开始后才赋值
            isTracking: false       // 控制是否记录数据
        };

        function getCollectionRef(name) {
            return collection(db, 'artifacts', appId, 'public', 'data', name);
        }

        // *** 1. 初始化 (Auth & Data Load, 但不开始考试) ***
        async function init() {
            try {
                // 后台连接数据库
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 后台加载试题
                await loadExamData();

            } catch (error) {
                console.error("Initialization failed:", error);
                document.getElementById('passage-title').innerText = "加载失败";
                document.getElementById('passage-content').innerText = "无法连接到数据库，请刷新重试。\n" + error.message;
            }
        }

        async function loadExamData() {
            console.log("Fetching passage...");
            const passageQuery = query(
                getCollectionRef("reading_materials"), 
                orderBy("created_at", "desc"), 
                limit(1)
            );
            
            const passageSnapshot = await getDocs(passageQuery);
            
            if (passageSnapshot.empty) {
                document.getElementById('passage-title').innerText = "暂无考试数据";
                document.getElementById('passage-content').innerText = "请先在管理后台录入文章和题目。";
                document.getElementById('q-stem').innerText = "No questions available.";
                return;
            }

            const passageDoc = passageSnapshot.docs[0];
            const passageData = passageDoc.data();
            const passageId = passageDoc.id;

            const questionsQuery = query(
                getCollectionRef("questions"),
                where("passage_id", "==", passageId)
            );
            
            const questionsSnapshot = await getDocs(questionsQuery);
            let questions = [];
            questionsSnapshot.forEach(doc => {
                questions.push({ id: doc.id, ...doc.data() });
            });

            // 排序
            questions.sort((a, b) => (a.created_at?.seconds || 0) - (b.created_at?.seconds || 0));

            state.examData = {
                id: passageId,
                title: passageData.title,
                content: passageData.content_html,
                questions: questions
            };

            // 渲染内容（背景中）
            renderInterface();
        }

        // *** 2. 注册表单处理 ***
        const regForm = document.getElementById('reg-form');
        regForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // 获取输入
            const name = document.getElementById('reg-name').value.trim().replace(/\s+/g, ''); // 去空格
            const gender = document.getElementById('reg-gender').value;
            const age = document.getElementById('reg-age').value;
            const grade = document.getElementById('reg-grade').value;
            
            // 生成日期后缀 MMDD
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const dateStr = `${month}${day}`;
            
            // 构造ID: Name_Gender_Age_Date
            const studentId = `${name}_${gender}_${age}_${dateStr}`;
            
            // 存储状态
            state.studentId = studentId;
            state.studentMeta = {
                name_raw: name,
                gender: gender,
                age: age,
                grade: grade,
                registered_at: now.toISOString()
            };
            
            // UI 更新
            document.getElementById('display-student-id').innerText = studentId;
            document.getElementById('registration-modal').style.display = 'none'; // 隐藏弹窗
            
            // 正式开始
            startExam();
        });

        function startExam() {
            if (!state.examData) {
                alert("试题尚未加载完成，请稍后...");
                document.getElementById('registration-modal').style.display = 'flex';
                return;
            }
            state.startTime = Date.now();
            state.isTracking = true;
            startTracking();
            startTimer();
            console.log("Exam Started for:", state.studentId);
        }

        // *** 3. 渲染逻辑 ***
        function renderInterface() {
            document.getElementById('passage-title').innerText = state.examData.title;
            document.getElementById('passage-content').innerHTML = state.examData.content;
            document.getElementById('q-total').innerText = state.examData.questions.length;
            renderQuestion();
        }

        function renderQuestion() {
            const q = state.examData.questions[state.currentQIndex];
            if (!q) return;

            document.getElementById('q-index').innerText = state.currentQIndex + 1;
            const progress = ((state.currentQIndex + 1) / state.examData.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            document.getElementById('q-stem').innerText = q.stem;
            
            const list = document.getElementById('options-list');
            list.innerHTML = '';
            
            if (Array.isArray(q.options)) {
                q.options.forEach((opt, idx) => {
                    const div = document.createElement('div');
                    div.className = "option-card border border-slate-200 rounded-lg p-4 cursor-pointer flex items-start gap-3 hover:border-blue-400 group";
                    div.onclick = () => selectOption(div, idx);
                    
                    div.innerHTML = `
                        <div class="w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center text-xs font-bold text-slate-400 group-hover:border-blue-400 group-hover:text-blue-500 transition-colors bg-white mt-0.5">
                            ${String.fromCharCode(65 + idx)}
                        </div>
                        <div class="text-sm text-slate-700 leading-relaxed">${opt}</div>
                    `;
                    list.appendChild(div);
                });
            }

            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-next').innerHTML = 
                state.currentQIndex === state.examData.questions.length - 1 
                ? 'Submit Exam <i class="fa-solid fa-check ml-2"></i>' 
                : 'Next Question <i class="fa-solid fa-arrow-right ml-2"></i>';
            
            state.hasEnteredAnswerZone = false;
            updatePhaseDisplay('reading');
        }

        window.selectOption = (el, idx) => {
            if (!state.isTracking) return;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('btn-next').disabled = false;
            
            logAction('select_option', { index: idx, q_id: state.examData.questions[state.currentQIndex].id });
        };

        window.nextQuestion = async () => {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';

            await flushLogs();

            if (state.currentQIndex < state.examData.questions.length - 1) {
                state.currentQIndex++;
                renderQuestion();
            } else {
                await submitFinalExamData();
                state.isTracking = false; // 停止记录
                alert("Exam Finished! Data uploaded.");
            }
        };
        
        async function submitFinalExamData() {
             const submissionRef = getCollectionRef("exam_submissions");
             await addDoc(submissionRef, {
                 session_id: state.sessionId,
                 user_id: state.studentId, // 使用生成的ID
                 user_meta: state.studentMeta, // 附带年级等元数据
                 passage_id: state.examData.id,
                 submitted_at: serverTimestamp(),
                 duration_seconds: Math.floor((Date.now() - state.startTime) / 1000),
                 total_questions: state.examData.questions.length
             });
        }

        // *** 4. 追踪逻辑 ***
        function startTracking() {
            const readingZone = document.getElementById('reading-aoi');
            const questionZone = document.getElementById('question-aoi');
            let lastTime = 0;
            
            document.addEventListener('mousemove', (e) => {
                if (!state.isTracking) return;
                
                const now = Date.now();
                let currentZone = 'neutral';
                if (readingZone.contains(e.target)) currentZone = 'reading';
                if (questionZone.contains(e.target)) currentZone = 'answering';

                if (currentZone === 'answering' && !state.hasEnteredAnswerZone) {
                    state.hasEnteredAnswerZone = true;
                    state.currentPhase = 'answering';
                    updatePhaseDisplay('answering');
                    logAction('phase_switch', { from: 'reading', to: 'answering' });
                }

                if (now - lastTime > 50) {
                    const point = {
                        t: now - state.startTime,
                        x: Math.round(e.clientX),
                        y: Math.round(e.clientY),
                        scroll: currentZone === 'reading' ? readingZone.scrollTop : questionZone.scrollTop
                    };

                    if (state.currentPhase === 'reading') {
                        state.logs.reading_logs.push(point); 
                    } else {
                        state.logs.answering_logs.push(point); 
                    }
                    lastTime = now;
                }
            });

            readingZone.addEventListener('scroll', () => {
                if (state.isTracking && state.currentPhase === 'reading') {
                    logAction('scroll', { top: readingZone.scrollTop, zone: 'reading' });
                }
            });
        }

        function updatePhaseDisplay(phase) {
            const dot = document.getElementById('phase-indicator');
            const text = document.getElementById('phase-text');
            
            if (phase === 'reading') {
                dot.className = "status-dot status-reading mr-2";
                text.innerText = "Reading Phase";
                text.className = "font-mono text-emerald-600 font-bold uppercase text-xs";
            } else {
                dot.className = "status-dot status-answering mr-2";
                text.innerText = "Decision Phase";
                text.className = "font-mono text-amber-600 font-bold uppercase text-xs";
            }
        }

        function logAction(type, data) {
            if (!state.isTracking) return;
            state.logs.transitions.push({
                type: type,
                t: Date.now() - state.startTime,
                ...data
            });
        }

        async function flushLogs() {
            if (!state.examData || !state.examData.questions[state.currentQIndex]) return;

            const packet = {
                q_id: state.examData.questions[state.currentQIndex].id,
                session_id: state.sessionId,
                user_id: state.studentId, // 使用生成的ID
                passage_id: state.examData.id,
                reading_trace: state.logs.reading_logs,
                decision_trace: state.logs.answering_logs, 
                events: state.logs.transitions,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(getCollectionRef("process_logs"), packet);
                
                state.logs.reading_logs = [];
                state.logs.answering_logs = [];
                state.logs.transitions = [];
            } catch (e) {
                console.error("Upload failed", e);
            }
        }

        function startTimer() {
            setInterval(() => {
                if (!state.isTracking) return;
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        // 初始化
        init();

    </script>
</body>
</html>
