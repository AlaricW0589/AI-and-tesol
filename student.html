<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CET Online Assessment | 沉浸式阅读测评</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 禁用文本选择，防止复制干扰实验数据 */
        body { user-select: none; }
        
        /* 自定义阅读区的滚动条，提升沉浸感 */
       .passage-scroll::-webkit-scrollbar { width: 8px; }
       .passage-scroll::-webkit-scrollbar-track { background: #f8fafc; }
       .passage-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
       .passage-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 选中态样式 */
       .option-card.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }

        /* 加载动画 */
       .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden font-sans text-slate-800">

    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-6 z-20 shadow-sm flex-none">
        <div class="flex items-center space-x-4">
            <span class="font-bold text-slate-700 tracking-wide">CET-6 Reading Comprehension</span>
            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-mono">Section C</span>
        </div>
        
        <div class="flex items-center space-x-6">
            <div class="text-sm text-gray-500">
                Question <span id="current-q-num" class="font-bold text-gray-900 text-lg">1</span> / <span id="total-q-num">--</span>
            </div>
            <div class="flex items-center space-x-2 px-3 py-1 bg-red-50 rounded-full border border-red-100">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-xs text-red-600 font-bold uppercase">REC</span>
            </div>
        </div>
    </header>

    <main id="exam-interface" class="flex-1 flex overflow-hidden relative opacity-0 transition-opacity duration-500">
        
        <section id="reading-pane" class="w-1/2 h-full overflow-y-auto passage-scroll bg-white border-r border-gray-200 p-8 lg:p-12 shadow-[inset_-10px_0_20px_-10px_rgba(0,0,0,0.05)] relative" region-id="passage">
            <div class="max-w-prose mx-auto">
                <div class="mb-6 pb-4 border-b border-gray-100">
                    <span id="passage-genre" class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Article Genre</span>
                    <h1 id="passage-title" class="text-2xl font-serif font-bold text-slate-800 leading-tight">Loading Passage...</h1>
                </div>
                
                <article id="passage-content" class="prose prose-slate prose-lg text-slate-600 leading-loose font-serif">
                    </article>
            </div>
        </section>

        <section id="item-pane" class="w-1/2 h-full bg-gray-50 flex flex-col relative" region-id="item">
            
            <div class="flex-1 overflow-y-auto p-8 lg:p-12 flex flex-col justify-center">
                <div class="max-w-lg mx-auto w-full">
                    
                    <div id="question-card" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 transition-all duration-300">
                        <div class="mb-6">
                            <span class="text-xs font-bold text-blue-600 mb-2 block uppercase">Multiple Choice</span>
                            <h2 id="q-stem" class="text-lg font-medium text-gray-900 leading-relaxed">
                                Loading Question...
                            </h2>
                        </div>

                        <div id="options-list" class="space-y-3">
                            </div>
                    </div>

                </div>
            </div>

            <div class="bg-white border-t border-gray-200 p-4 flex justify-end items-center flex-none z-10">
                <button id="btn-next" onclick="nextQuestion()" disabled class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                    <span>Next Question</span>
                    <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

    </main>

    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center space-y-4">
        <div class="loader"></div>
        <p class="text-gray-500 font-mono text-sm">Initializing Exam Environment...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *** 配置信息 ***
        const firebaseConfig = {
            apiKey: "AIzaSyCsc75cgtVOCBI_GjVh-l8RsrhOcCIkNqw",
            authDomain: "hesitation-research.firebaseapp.com",
            projectId: "hesitation-research",
            storageBucket: "hesitation-research.firebasestorage.app",
            messagingSenderId: "633469376688",
            appId: "1:633469376688:web:dc26878c070a05a35b4375"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // *** 全局状态 (State Management) ***
        const state = {
            userId: "user_" + Math.random().toString(36).substr(2, 9), // 模拟匿名用户ID
            sessionId: Date.now().toString(),
            examSequence:, // 扁平化的题目序列
            passagesCache: {}, // 缓存文章内容 {id: data}
            currentIndex: 0,
            
            // 过程数据临时存储
            currentLog: {
                trajectory:, // 鼠标轨迹
                startTime: 0,
                passageScrollDepth: 0 // 记录读了多少
            }
        };

        // *** 1. 初始化：构建考试序列 (Test Assembly) ***
        async function initExam() {
            try {
                // 1.1 获取所有题目
                // 注意：真实场景下这里应该按Exam ID筛选，此处简化为拉取全量
                const qSnapshot = await getDocs(collection(db, "questions"));
                
                if (qSnapshot.empty) {
                    alert("No questions found in database.");
                    return;
                }

                // 1.2 构建题目队列
                // 我们需要按 passage_id 对题目进行排序，确保同一篇文章的题目连续出现
                const rawQuestions =;
                qSnapshot.forEach(doc => {
                    rawQuestions.push({ id: doc.id,...doc.data() });
                });

                // 按文章分组排序 (Passage-Based Testlet Structure)
                rawQuestions.sort((a, b) => a.passage_id.localeCompare(b.passage_id));
                state.examSequence = rawQuestions;

                // 1.3 预加载所有相关的文章 (Pre-fetch Passages)
                const uniquePassageIds =;
                await Promise.all(uniquePassageIds.map(async (pid) => {
                    const pDoc = await getDoc(doc(db, "reading_materials", pid));
                    if (pDoc.exists()) {
                        state.passagesCache[pid] = pDoc.data();
                    }
                }));

                // 1.4 渲染UI
                document.getElementById('total-q-num').innerText = state.examSequence.length;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('exam-interface').classList.remove('opacity-0');
                
                renderCurrentQuestion();

            } catch (error) {
                console.error("Init Error:", error);
                alert("Failed to load exam data. See console.");
            }
        }

        // *** 2. 渲染逻辑 (Rendering) ***
        function renderCurrentQuestion() {
            const currentQ = state.examSequence[state.currentIndex];
            const passageData = state.passagesCache[currentQ.passage_id];

            // 2.1 更新文章区 (仅当文章切换时才重绘DOM，优化性能)
            const passageTitleEl = document.getElementById('passage-title');
            if (passageTitleEl.innerText!== passageData.title) {
                passageTitleEl.innerText = passageData.title;
                document.getElementById('passage-genre').innerText = passageData.genre |

| "Article";
                document.getElementById('passage-content').innerHTML = passageData.content_html;
                
                // 重置滚动条
                document.getElementById('reading-pane').scrollTop = 0;
            }

            // 2.2 更新题目区
            document.getElementById('current-q-num').innerText = state.currentIndex + 1;
            document.getElementById('q-stem').innerText = currentQ.stem;

            // 2.3 生成选项
            const optionsContainer = document.getElementById('options-list');
            optionsContainer.innerHTML = '';
            
            currentQ.options.forEach((optText, idx) => {
                const btn = document.createElement('div');
                btn.className = "option-card flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all group";
                btn.setAttribute('data-index', idx);
                btn.innerHTML = `
                    <span class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 font-bold text-sm mr-4 group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors">${String.fromCharCode(65 + idx)}</span>
                    <span class="text-sm text-gray-700 flex-1">${optText}</span>
                `;
                
                btn.onclick = () => selectOption(idx);
                optionsContainer.appendChild(btn);
            });

            // 2.4 重置状态与开始计时
            document.getElementById('btn-next').disabled = true;
            state.currentLog.startTime = Date.now();
            state.currentLog.trajectory =;
            state.currentLog.selectedIdx = null;
        }

        // *** 3. 交互逻辑 (Interaction) ***
        window.selectOption = function(idx) {
            // UI更新
            const cards = document.querySelectorAll('.option-card');
            cards.forEach(c => c.classList.remove('selected'));
            cards[idx].classList.add('selected');
            
            // 状态更新
            state.currentLog.selectedIdx = idx;
            document.getElementById('btn-next').disabled = false;
        };

        window.nextQuestion = async function() {
            const btn = document.getElementById('btn-next');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            
            await submitCurrentData();

            if (state.currentIndex < state.examSequence.length - 1) {
                state.currentIndex++;
                renderCurrentQuestion();
                btn.innerHTML = '<span>Next Question</span><i class="fa-solid fa-arrow-right ml-2"></i>';
            } else {
                alert("Exam Completed! Thank you for your participation.");
                window.location.reload();
            }
        };

        // *** 4. 数据提交与阴影参数更新 (Data Submission) ***
        async function submitCurrentData() {
            const qData = state.examSequence[state.currentIndex];
            const pData = state.passagesCache;
            
            // 4.1 构建过程数据日志
            // 注意：这里我们不直接判断对错，而是将选择上传。
            // 真实的参数更新（Elo）将在后端 Cloud Function 中触发
            const logData = {
                session_id: state.sessionId,
                user_id: state.userId,
                item_id: qData.id,
                passage_id: qData.passage_id,
                
                // 核心作答数据
                response: {
                    selected_index: state.currentLog.selectedIdx,
                    response_time_ms: Date.now() - state.currentLog.startTime,
                    timestamp: serverTimestamp()
                },

                // 行为数据 (用于分析犹豫)
                behavior_metrics: {
                    passage_scroll_depth: document.getElementById('reading-pane').scrollTop, // 读到哪了
                    trajectory_count: state.currentLog.trajectory.length,
                    // 实际轨迹数据量可能很大，建议压缩或仅存储关键特征
                    // 这里为了演示，我们截取前1000个点
                    trajectory_sample: state.currentLog.trajectory.slice(0, 1000) 
                },

                // 影子参数元数据 (传递给后端算法的上下文)
                shadow_context: {
                    current_shadow_b: qData.shadow_parameters?.b_hat |

| 0, // 当前估计的难度
                    passage_difficulty: pData.shadow_difficulty |

| 0
                }
            };

            // 4.2 写入 Firestore
            await addDoc(collection(db, "interaction_logs"), logData);
            console.log("Log saved:", logData);
        }

        // *** 5. 高频轨迹追踪 (Mouse Tracking Engine) ***
        const readingPane = document.getElementById('reading-pane');
        const itemPane = document.getElementById('item-pane');

        // 节流函数，防止每毫秒都记录
        let lastTrackTime = 0;
        const TRACK_INTERVAL = 50; // 50ms = 20Hz 采样率

        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            if (now - lastTrackTime < TRACK_INTERVAL) return;
            
            // 5.1 判定区域 (Context Awareness)
            let region = 'neutral'; // 空白区域
            let relativeX = e.clientX;
            let relativeY = e.clientY;

            // 检测鼠标是否在阅读区
            const rRect = readingPane.getBoundingClientRect();
            if (e.clientX >= rRect.left && e.clientX <= rRect.right) {
                region = 'passage';
                // 记录相对于阅读内容的Y坐标 (考虑滚动)
                relativeY = e.clientY + readingPane.scrollTop; 
            } 
            // 检测鼠标是否在题目区
            else {
                const iRect = itemPane.getBoundingClientRect();
                if (e.clientX >= iRect.left) {
                    region = 'item';
                }
            }

            // 5.2 记录数据点
            state.currentLog.trajectory.push({
                t: now - state.currentLog.startTime, // 相对时间
                x: Math.round(e.clientX),
                y: Math.round(e.clientY),
                r: region, // 语义区域
                s: readingPane.scrollTop // 同步记录滚动位置
            });

            lastTrackTime = now;
        });

        // 启动
        initExam();

    </script>
</body>
</html>
